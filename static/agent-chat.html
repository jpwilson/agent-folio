<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent-Folio</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='16' fill='%230d0d0d'/%3E%3Ctext x='50' y='72' font-family='Arial,sans-serif' font-size='72' font-weight='bold' fill='%2336cfb4' text-anchor='middle'%3EA%3C/text%3E%3C/svg%3E">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0c0c0c;
      color: #e0e0e0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: #111111;
      padding: 10px 24px;
      border-bottom: 1px solid #2a2a2a;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: padding 0.3s ease;
    }
    header.chat-active { padding: 18px 24px; }
    header a.back {
      color: #36cfb4;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      transition: background 0.2s;
    }
    header a.back:hover { background: #1a1a1a; }
    .header-left { display: flex; align-items: center; gap: 10px; }
    header h1 { font-size: 18px; font-weight: 600; color: #ffffff; }
    header span.subtitle { font-size: 12px; color: #666; }
    header .sdk-badge {
      font-size: 10px; padding: 2px 8px; border-radius: 10px;
      background: rgba(54, 207, 180, 0.1); color: #36cfb4;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .header-center-logo {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: none;
    }
    .header-center-logo.visible { display: block; }
    .header-center-logo .logo-text {
      font-size: 20px; font-weight: 700; color: #36cfb4;
      letter-spacing: 2px;
    }
    .header-actions { margin-left: auto; display: flex; align-items: center; gap: 10px; }
    .header-actions button {
      padding: 6px 14px; font-size: 12px; background: #1a1a1a;
      border: 1px solid #2a2a2a; color: #e0e0e0; border-radius: 6px; cursor: pointer;
    }
    .header-actions button:hover { background: #252525; }
    .status { font-size: 12px; color: #36cfb4; display: flex; align-items: center; gap: 6px; }
    .status::before {
      content: ''; width: 8px; height: 8px; background: #36cfb4;
      border-radius: 50%; display: inline-block;
    }
    .status.disconnected { color: #f87171; }
    .status.disconnected::before { background: #f87171; }
    .account-badge {
      font-size: 11px; padding: 3px 10px; border-radius: 12px;
      background: rgba(54, 207, 180, 0.1); color: #36cfb4; border: 1px solid rgba(54, 207, 180, 0.2);
      white-space: nowrap; position: relative;
    }
    .account-badge.grader { background: rgba(250, 204, 21, 0.1); color: #facc15; border-color: rgba(250, 204, 21, 0.2); }

    /* Profile dropdown */
    .profile-dropdown {
      position: absolute; top: 100%; right: 0; margin-top: 6px;
      background: #1a1a1a; border: 1px solid #333; border-radius: 12px;
      min-width: 320px; z-index: 1000; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      display: none; padding: 0; overflow: hidden;
    }
    .profile-dropdown.visible { display: block; }
    .profile-dropdown .pd-header {
      padding: 16px; border-bottom: 1px solid #2a2a2a;
    }
    .profile-dropdown .pd-header .pd-name {
      font-size: 14px; font-weight: 600; color: #e5e5e5;
    }
    .profile-dropdown .pd-header .pd-id {
      font-size: 11px; color: #888; margin-top: 2px;
    }
    .profile-dropdown .pd-section-title {
      font-size: 11px; font-weight: 600; color: #888; text-transform: uppercase;
      letter-spacing: 0.5px; padding: 12px 16px 6px;
    }
    .profile-dropdown .pd-backend {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 16px; gap: 8px;
    }
    .profile-dropdown .pd-backend:hover { background: rgba(255,255,255,0.03); }
    .profile-dropdown .pd-backend .pd-be-info {
      display: flex; flex-direction: column; flex: 1; min-width: 0;
    }
    .profile-dropdown .pd-backend .pd-be-label {
      font-size: 12px; color: #e5e5e5; font-weight: 500;
    }
    .profile-dropdown .pd-backend .pd-be-url {
      font-size: 10px; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .profile-dropdown .pd-be-provider {
      font-size: 10px; padding: 2px 6px; border-radius: 4px;
      background: rgba(54,207,180,0.1); color: #36cfb4; font-weight: 600;
    }
    .profile-dropdown .pd-be-toggle {
      width: 36px; height: 20px; border-radius: 10px; border: none;
      cursor: pointer; position: relative; transition: background 0.2s;
    }
    .profile-dropdown .pd-be-toggle.active { background: #36cfb4; }
    .profile-dropdown .pd-be-toggle.inactive { background: #444; }
    .profile-dropdown .pd-be-toggle::after {
      content: ''; position: absolute; width: 16px; height: 16px;
      border-radius: 50%; background: white; top: 2px; transition: left 0.2s;
    }
    .profile-dropdown .pd-be-toggle.active::after { left: 18px; }
    .profile-dropdown .pd-be-toggle.inactive::after { left: 2px; }
    .profile-dropdown .pd-be-actions {
      display: flex; gap: 4px;
    }
    .profile-dropdown .pd-be-actions button {
      background: none; border: none; color: #888; cursor: pointer; font-size: 12px; padding: 2px 4px;
    }
    .profile-dropdown .pd-be-actions button:hover { color: #e5e5e5; }
    .profile-dropdown .pd-add-btn {
      display: block; width: calc(100% - 32px); margin: 8px 16px;
      padding: 8px; border-radius: 8px; border: 1px dashed #444;
      background: none; color: #888; cursor: pointer; font-size: 12px; text-align: center;
    }
    .profile-dropdown .pd-add-btn:hover { border-color: #36cfb4; color: #36cfb4; }
    .profile-dropdown .pd-footer {
      border-top: 1px solid #2a2a2a; padding: 8px 16px; display: flex; justify-content: space-between; align-items: center;
    }
    .profile-dropdown .pd-footer button {
      background: none; border: none; cursor: pointer;
      font-size: 12px; padding: 6px 12px; border-radius: 6px;
    }
    .profile-dropdown .pd-footer .pd-settings-btn { color: #888; }
    .profile-dropdown .pd-footer .pd-settings-btn:hover { background: rgba(255,255,255,0.05); color: #e5e5e5; }
    .profile-dropdown .pd-footer .pd-signout-btn { color: #f87171; }
    .profile-dropdown .pd-footer .pd-signout-btn:hover { background: rgba(248,113,113,0.1); }
    .backends-badge {
      font-size: 10px; color: #888; margin-left: 4px;
    }

    /* Add backend modal */
    .add-backend-modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000;
      display: none; align-items: center; justify-content: center;
    }
    .add-backend-modal.visible { display: flex; }
    .add-backend-modal .abm-content {
      background: #1a1a1a; border: 1px solid #333; border-radius: 12px;
      padding: 24px; width: 400px; max-width: 90vw;
    }
    .add-backend-modal .abm-content h3 { margin: 0 0 16px; font-size: 16px; color: #e5e5e5; }
    .add-backend-modal .abm-field { margin-bottom: 12px; }
    .add-backend-modal .abm-field label { display: block; font-size: 12px; color: #888; margin-bottom: 4px; }
    .add-backend-modal .abm-field input,
    .add-backend-modal .abm-field select {
      width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid #333;
      background: #111; color: #e5e5e5; font-size: 13px; box-sizing: border-box;
    }
    .add-backend-modal .abm-actions {
      display: flex; justify-content: flex-end; gap: 8px; margin-top: 16px;
    }
    .add-backend-modal .abm-actions button {
      padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px;
    }
    .add-backend-modal .abm-cancel { background: #333; color: #e5e5e5; }
    .add-backend-modal .abm-save { background: #36cfb4; color: #000; font-weight: 600; }
    .main-content { display: flex; flex: 1; overflow: hidden; }

    /* Sidebar */
    #sidebar {
      width: 280px; background: #111111; border-right: 1px solid #2a2a2a;
      display: flex; flex-direction: column; overflow: hidden;
    }
    .sidebar-header { padding: 14px 14px 10px; border-bottom: 1px solid #2a2a2a; }
    .sidebar-header h3 {
      font-size: 13px; color: #36cfb4; text-transform: uppercase;
      letter-spacing: 1px; margin-bottom: 10px; font-weight: 700;
    }
    .sidebar-search {
      width: 100%; padding: 8px 12px; background: #0c0c0c;
      border: 1px solid #2a2a2a; border-radius: 6px; color: #e0e0e0;
      font-size: 13px; outline: none; font-family: inherit;
    }
    .sidebar-search:focus { border-color: #36cfb4; }
    .sidebar-search::placeholder { color: #555; }
    .category-tabs {
      display: flex; flex-wrap: wrap; gap: 6px;
      padding: 10px 14px; border-bottom: 1px solid #2a2a2a;
    }
    .category-tab {
      padding: 4px 10px; font-size: 12px; background: #1a1a1a;
      border: 1px solid #2a2a2a; color: #999; border-radius: 12px;
      cursor: pointer; text-transform: capitalize; transition: all 0.15s;
    }
    .category-tab:hover { border-color: #36cfb4; color: #36cfb4; }
    .category-tab.active {
      background: rgba(54, 207, 180, 0.15); border-color: #36cfb4; color: #36cfb4;
    }
    .conv-list-area { flex: 1; overflow-y: auto; }
    .conv-item {
      padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #1a1a1a;
      font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .conv-item:hover { background: #1a1a1a; }
    .conv-item.active { background: #1a2a2a; border-left: 3px solid #36cfb4; }
    .conv-item .conv-date { font-size: 11px; color: #666; margin-top: 3px; }
    .conv-item .conv-category {
      display: inline-block; font-size: 10px; padding: 2px 7px; border-radius: 8px;
      background: rgba(54, 207, 180, 0.1); color: #36cfb4; margin-left: 6px; text-transform: capitalize;
    }
    .conv-item .conv-delete { float: right; color: #666; font-size: 13px; padding: 2px 6px; border-radius: 4px; }
    .conv-item .conv-delete:hover { background: #3b1111; color: #f87171; }
    .conv-item.hidden { display: none; }

    /* Agent Admin Toggle */
    .admin-panel-toggle { margin-top: auto; padding: 12px 14px; border-top: 1px solid #2a2a2a; }
    .admin-panel-toggle button {
      width: 100%; padding: 12px 16px; font-size: 14px; font-weight: 600;
      background: rgba(54, 207, 180, 0.06); border: 1px solid #36cfb4;
      color: #36cfb4; border-radius: 8px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      transition: all 0.2s; box-shadow: 0 0 8px rgba(54, 207, 180, 0.1);
    }
    .admin-panel-toggle button:hover {
      background: rgba(54, 207, 180, 0.12); box-shadow: 0 0 16px rgba(54, 207, 180, 0.2);
    }
    .admin-panel-toggle .admin-icon { font-size: 16px; }

    /* Admin Modal */
    .admin-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
      z-index: 1000; justify-content: center; align-items: center;
    }
    .admin-overlay.visible { display: flex; }
    .admin-modal {
      background: #151515; border: 1px solid #2a2a2a; border-radius: 12px;
      width: 720px; max-width: 90vw; max-height: 80vh; overflow: hidden;
      display: flex; flex-direction: column;
    }
    .admin-modal-header {
      padding: 16px 20px; border-bottom: 1px solid #2a2a2a;
      display: flex; align-items: center; justify-content: space-between;
    }
    .admin-modal-header h2 {
      font-size: 16px; font-weight: 600; color: #fff;
      display: flex; align-items: center; gap: 8px;
    }
    .admin-modal-header h2 .admin-badge {
      font-size: 9px; background: rgba(54,207,180,0.15); color: #36cfb4;
      padding: 2px 8px; border-radius: 10px; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .admin-modal-header .close-btn {
      background: none; border: none; color: #666; font-size: 20px;
      cursor: pointer; padding: 4px 8px; border-radius: 4px;
    }
    .admin-modal-header .close-btn:hover { background: #1a1a1a; color: #e0e0e0; }
    .admin-tabs { display: flex; border-bottom: 1px solid #2a2a2a; padding: 0 20px; }
    .admin-tab {
      padding: 10px 16px; font-size: 12px; color: #666; cursor: pointer;
      border-bottom: 2px solid transparent; transition: all 0.2s;
    }
    .admin-tab:hover { color: #e0e0e0; }
    .admin-tab.active { color: #36cfb4; border-bottom-color: #36cfb4; }
    .admin-modal-body { padding: 20px; overflow-y: auto; flex: 1; }
    .admin-section { margin-bottom: 20px; }
    .admin-section h3 {
      font-size: 13px; font-weight: 600; color: #36cfb4; margin-bottom: 10px;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .admin-card {
      background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 8px;
      padding: 14px; margin-bottom: 8px;
    }
    .admin-stat-row { display: flex; gap: 12px; margin-bottom: 12px; }
    .admin-stat {
      flex: 1; background: #1a1a1a; border: 1px solid #2a2a2a;
      border-radius: 8px; padding: 14px; text-align: center;
    }
    .admin-stat .stat-value { font-size: 24px; font-weight: 700; color: #36cfb4; }
    .admin-stat .stat-label { font-size: 10px; color: #666; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
    .admin-placeholder {
      color: #555; font-size: 12px; text-align: center; padding: 24px;
      border: 1px dashed #2a2a2a; border-radius: 8px;
    }
    .admin-list-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 0; border-bottom: 1px solid #1a1a1a; font-size: 12px;
    }
    .admin-list-item:last-child { border-bottom: none; }
    .admin-list-item .label { color: #999; }
    .admin-list-item .value { color: #e0e0e0; font-weight: 500; }
    /* Admin toggle switches */
    .admin-toggle-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 0; border-bottom: 1px solid #222;
    }
    .admin-toggle-row:last-child { border-bottom: none; }
    .admin-toggle-row .toggle-label { font-size: 13px; color: #ccc; }
    .admin-toggle-row .toggle-desc { font-size: 11px; color: #666; margin-top: 2px; }
    .toggle-switch {
      position: relative; width: 40px; height: 22px; cursor: pointer;
    }
    .toggle-switch input { display: none; }
    .toggle-switch .slider {
      position: absolute; inset: 0; background: #333; border-radius: 11px; transition: 0.2s;
    }
    .toggle-switch .slider::before {
      content: ''; position: absolute; width: 16px; height: 16px;
      left: 3px; top: 3px; background: #888; border-radius: 50%; transition: 0.2s;
    }
    .toggle-switch input:checked + .slider { background: rgba(54, 207, 180, 0.3); }
    .toggle-switch input:checked + .slider::before { transform: translateX(18px); background: #36cfb4; }
    /* SDK/Provider admin styles */
    .admin-select {
      width: 100%; padding: 10px 36px 10px 12px; background: #0c0c0c; border: 1px solid #2a2a2a;
      border-radius: 6px; color: #e0e0e0; font-size: 13px; font-family: inherit;
      outline: none; appearance: none; cursor: pointer;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23666' stroke-width='1.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }
    .admin-select:focus { border-color: #36cfb4; }
    .admin-select option { background: #0c0c0c; color: #e0e0e0; }
    .model-desc { font-size: 11px; color: #666; margin-top: 4px; line-height: 1.4; }
    .admin-input {
      width: 100%; padding: 10px 12px; background: #0c0c0c; border: 1px solid #2a2a2a;
      border-radius: 6px; color: #e0e0e0; font-size: 13px; font-family: inherit;
      outline: none;
    }
    .admin-input:focus { border-color: #36cfb4; }
    .admin-input::placeholder { color: #444; }
    .admin-save-btn {
      padding: 10px 24px; background: #1a3a35; border: 1px solid #2a5a4a;
      color: #36cfb4; border-radius: 6px; font-size: 13px; cursor: pointer;
      font-weight: 600; transition: all 0.2s;
    }
    .admin-save-btn:hover { background: #245a4a; }
    .admin-save-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .sdk-option-desc { font-size: 11px; color: #666; margin-top: 4px; }
    .sdk-active-indicator {
      display: inline-block; width: 8px; height: 8px; background: #36cfb4;
      border-radius: 50%; margin-right: 6px;
    }
    .settings-saved-msg {
      display: none; font-size: 12px; color: #36cfb4; margin-top: 8px;
    }
    .settings-saved-msg.visible { display: block; }

    /* Chat area */
    #chat-area { flex: 1; display: flex; flex-direction: column; }
    #chat {
      flex: 1; overflow-y: auto; padding: 24px;
      display: flex; flex-direction: column; gap: 16px;
    }
    .message {
      max-width: 80%; padding: 12px 16px; border-radius: 12px;
      line-height: 1.6; font-size: 14px;
    }
    .message.user {
      align-self: flex-end; background: #1a3a35; border: 1px solid #2a5a4a;
      border-bottom-right-radius: 4px; white-space: pre-wrap;
    }
    .message.assistant {
      align-self: flex-start; background: #1a1a1a; border: 1px solid #2a2a2a;
      border-bottom-left-radius: 4px;
    }
    .message.assistant .msg-content h1,
    .message.assistant .msg-content h2,
    .message.assistant .msg-content h3 {
      color: #36cfb4; margin: 12px 0 6px; font-weight: 600;
    }
    .message.assistant .msg-content h1 { font-size: 18px; }
    .message.assistant .msg-content h2 { font-size: 16px; }
    .message.assistant .msg-content h3 { font-size: 14px; }
    .message.assistant .msg-content p { margin: 6px 0; }
    .message.assistant .msg-content ul,
    .message.assistant .msg-content ol { margin: 6px 0; padding-left: 20px; }
    .message.assistant .msg-content li { margin: 3px 0; }
    .message.assistant .msg-content strong { color: #fff; }
    .message.assistant .msg-content em { color: #aaa; }
    .message.assistant .msg-content code {
      background: #0a1a18; color: #36cfb4; padding: 1px 5px;
      border-radius: 3px; font-size: 13px;
    }
    .message.assistant .msg-content pre {
      background: #0a0a0a; border: 1px solid #2a2a2a; border-radius: 6px;
      padding: 10px; overflow-x: auto; margin: 8px 0;
    }
    .message.assistant .msg-content pre code { background: none; padding: 0; }
    .message.assistant .msg-content table {
      border-collapse: collapse; width: 100%; margin: 8px 0; font-size: 13px;
    }
    .message.assistant .msg-content th {
      background: #0a1a18; color: #36cfb4; text-align: left;
      padding: 8px 10px; border: 1px solid #2a2a2a; font-weight: 600;
    }
    .message.assistant .msg-content td {
      padding: 6px 10px; border: 1px solid #222; color: #ccc;
    }
    .message.assistant .msg-content tr:nth-child(even) td { background: rgba(255,255,255,0.02); }
    .message.assistant .msg-content blockquote {
      border-left: 3px solid #36cfb4; padding: 6px 12px; margin: 8px 0;
      background: rgba(54, 207, 180, 0.05); color: #aaa;
    }
    .message.assistant .msg-content hr {
      border: none; border-top: 1px solid #2a2a2a; margin: 10px 0;
    }
    .message.assistant .msg-content.raw { white-space: pre-wrap; }
    .chart-container {
      margin: 12px 0; padding: 16px; background: #0f0f0f;
      border: 1px solid #2a2a2a; border-radius: 8px; max-width: 480px;
    }
    .chart-container .chart-title {
      font-size: 12px; color: #36cfb4; font-weight: 600;
      margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .chart-container canvas { max-height: 280px; }
    .message.assistant .tool-calls {
      margin-top: 10px; padding-top: 8px; border-top: 1px solid #2a2a2a;
      font-size: 11px; color: #888;
    }
    .message.assistant .tool-calls span {
      background: #0a1a18; padding: 2px 8px; border-radius: 4px;
      margin-right: 4px; font-family: monospace; color: #36cfb4;
    }
    .verification {
      margin-top: 6px; padding-top: 6px; border-top: 1px solid #333; font-size: 11px;
    }
    .verification.pass { color: #36cfb4; }
    .verification.fail { color: #f87171; }
    .msg-feedback {
      margin-top: 14px; padding-top: 12px;
      border-top: 1px solid #333;
    }
    .msg-feedback .fb-row {
      display: flex; align-items: center; gap: 4px;
    }
    .msg-feedback button.fb-btn {
      background: none; border: 1px solid #333; color: #666;
      padding: 2px 8px; border-radius: 4px; font-size: 12px;
      cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 3px;
    }
    .msg-feedback button.fb-btn:hover { border-color: #555; color: #aaa; }
    .msg-feedback button.fb-btn.liked { border-color: #36cfb4; color: #36cfb4; background: rgba(54,207,180,0.08); }
    .msg-feedback button.fb-btn.disliked { border-color: #f87171; color: #f87171; background: rgba(248,113,113,0.08); }
    .msg-feedback .fb-prompt {
      font-size: 10px; color: #555; margin-top: 4px; font-style: italic;
    }
    .msg-feedback .fb-explain {
      display: none; margin-top: 6px; align-items: center; gap: 6px;
    }
    .msg-feedback .fb-explain.visible { display: flex; }
    .msg-feedback .fb-explain input {
      flex: 1; padding: 5px 10px; font-size: 11px; background: #0c0c0c;
      border: 1px solid #333; border-radius: 5px; color: #ccc; outline: none; font-family: inherit;
    }
    .msg-feedback .fb-explain input:focus { border-color: #36cfb4; }
    .msg-feedback .fb-explain input::placeholder { color: #444; }
    .msg-feedback .fb-explain button.fb-submit {
      background: #1a3a35; border: 1px solid #2a5a4a; color: #36cfb4;
      padding: 5px 10px; border-radius: 5px; font-size: 12px; cursor: pointer;
    }
    .msg-feedback .fb-explain button.fb-submit:hover { background: #245a4a; }
    .msg-feedback .fb-recorded {
      display: none; font-size: 11px; color: #36cfb4; margin-top: 6px;
    }
    .msg-feedback .fb-recorded.visible { display: block; }
    .msg-feedback.fb-done .fb-row,
    .msg-feedback.fb-done .fb-prompt,
    .msg-feedback.fb-done .fb-explain { display: none !important; }
    body.hide-tools .tool-calls { display: none !important; }
    body.hide-verification .verification { display: none !important; }
    body.hide-feedback .msg-feedback { display: none !important; }

    .message.error {
      align-self: center; background: #3b1111; color: #f87171; font-size: 12px;
      white-space: pre-wrap;
    }
    .typing { align-self: flex-start; color: #36cfb4; font-size: 13px; padding: 8px 16px; }
    .typing::after { content: '...'; animation: dots 1.5s infinite; }
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    .progress-bar {
      align-self: flex-start;
      padding: 8px 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-width: 400px;
    }
    .progress-step {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #888;
      transition: color 0.3s;
    }
    .progress-step.active { color: #36cfb4; }
    .progress-step.done { color: #555; }
    .progress-step .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid #333;
      border-top-color: #36cfb4;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .progress-step.done .spinner {
      border: none;
      animation: none;
    }
    .progress-step.done .spinner::after { content: '\2713'; color: #36cfb4; font-size: 12px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #input-area {
      padding: 16px 24px; background: #111111; border-top: 1px solid #2a2a2a;
      display: flex; gap: 12px;
    }
    #input {
      flex: 1; padding: 12px 16px; border-radius: 8px; border: 1px solid #2a2a2a;
      background: #0c0c0c; color: #e0e0e0; font-size: 14px; outline: none; font-family: inherit;
    }
    #input:focus { border-color: #36cfb4; }
    #input::placeholder { color: #555; }
    button {
      padding: 12px 24px; border-radius: 8px; border: none;
      background: #1a3a35; color: #36cfb4; font-size: 14px;
      cursor: pointer; font-family: inherit; font-weight: 500;
    }
    button:hover { background: #245a4a; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .welcome { text-align: center; color: #666; margin: auto; font-size: 14px; line-height: 2; }
    .welcome h2 { color: #36cfb4; font-size: 18px; margin-bottom: 8px; }
    .welcome .logo-large { margin-bottom: 16px; display: flex; justify-content: center; }
    .suggestions { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 12px; }
    .suggestions button {
      padding: 8px 14px; font-size: 12px; background: #1a1a1a;
      border: 1px solid #2a2a2a; color: #e0e0e0;
    }
    .suggestions button:hover { background: #1a2a2a; border-color: #36cfb4; color: #36cfb4; }
    /* Suggestion category tabs on welcome screen */
    .suggestion-cats { display: flex; gap: 6px; justify-content: center; margin: 16px 0 4px; flex-wrap: wrap; }
    .suggestion-cat-btn {
      padding: 5px 12px; font-size: 11px; background: #1a1a1a;
      border: 1px solid #2a2a2a; color: #888; border-radius: 14px;
      cursor: pointer; transition: all 0.15s;
    }
    .suggestion-cat-btn:hover { border-color: #36cfb4; color: #36cfb4; }
    .suggestion-cat-btn.active { background: rgba(54,207,180,0.12); border-color: #36cfb4; color: #36cfb4; }
    .suggestion-label {
      font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: 0.5px;
      margin: 10px 0 4px; text-align: center;
    }

    /* Follow-up suggestions bar */
    #followups-bar {
      display: none; padding: 8px 24px 0; background: #111111;
    }
    #followups-bar.visible { display: block; }
    #followups-bar .followups-label {
      font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: 0.5px;
      margin-bottom: 6px; cursor: pointer; display: flex; align-items: center; gap: 4px;
    }
    #followups-bar .followups-label .arrow { transition: transform 0.2s; font-size: 8px; }
    #followups-bar .followups-label .arrow.collapsed { transform: rotate(-90deg); }
    #followups-bar .followups-list {
      display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 4px;
    }
    #followups-bar .followups-list.collapsed { display: none; }
    #followups-bar .followup-btn {
      padding: 6px 12px; font-size: 12px; background: #1a1a1a;
      border: 1px solid #2a2a2a; color: #ccc; border-radius: 16px;
      cursor: pointer; transition: all 0.15s;
    }
    #followups-bar .followup-btn:hover { border-color: #36cfb4; color: #36cfb4; background: #1a2a2a; }

    /* Help button in sidebar */
    .help-section {
      padding: 8px 14px 8px; display: flex; flex-direction: column; align-items: center;
      position: relative;
    }
    #help-fab {
      width: 36px; height: 36px; min-width: 36px; min-height: 36px;
      padding: 0; border-radius: 50%;
      background: #0c0c0c; border: 1.5px solid #36cfb4;
      color: #36cfb4; font-size: 16px; font-weight: 700;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 12px rgba(54, 207, 180, 0.25);
      transition: all 0.2s;
    }
    #help-fab:hover {
      background: #1a3a35;
      box-shadow: 0 0 20px rgba(54, 207, 180, 0.4);
    }
    #help-menu {
      position: absolute; bottom: 44px; left: 50%; transform: translateX(-50%);
      z-index: 51; background: #161616; border: 1px solid #2a2a2a; border-radius: 8px;
      display: none; min-width: 180px; overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    #help-menu.visible { display: block; }
    #help-menu .help-item {
      padding: 10px 16px; font-size: 13px; color: #ccc; cursor: pointer;
      display: flex; align-items: center; gap: 8px; transition: background 0.15s;
    }
    #help-menu .help-item:hover { background: #1a2a2a; color: #36cfb4; }
    #help-menu .help-item .help-icon { font-size: 14px; width: 18px; text-align: center; }

    /* Changelog overlay */
    .changelog-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); z-index: 200;
      display: none; align-items: center; justify-content: center;
    }
    .changelog-overlay.visible { display: flex; }
    .changelog-modal {
      background: #141414; border: 1px solid #2a2a2a; border-radius: 12px;
      width: 600px; max-width: 90vw; max-height: 80vh;
      display: flex; flex-direction: column; overflow: hidden;
    }
    .changelog-header {
      padding: 20px 24px 16px; border-bottom: 1px solid #2a2a2a;
      display: flex; align-items: center; justify-content: space-between;
    }
    .changelog-header h2 { font-size: 18px; color: #36cfb4; font-weight: 600; }
    .changelog-close {
      background: none; border: none; color: #666; font-size: 20px;
      cursor: pointer; padding: 4px 8px; border-radius: 4px;
    }
    .changelog-close:hover { color: #e0e0e0; background: #1a1a1a; }
    .changelog-body { padding: 16px 24px 24px; overflow-y: auto; flex: 1; }
    .changelog-entry {
      padding: 14px 0; border-bottom: 1px solid #1e1e1e;
    }
    .changelog-entry:last-child { border-bottom: none; }
    .changelog-entry-top {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 6px;
    }
    .changelog-entry-left { display: flex; align-items: center; gap: 10px; }
    .changelog-date {
      font-size: 11px; color: #555; font-family: monospace;
    }
    .changelog-title {
      font-size: 14px; color: #e0e0e0; font-weight: 500;
    }
    .changelog-desc {
      font-size: 12px; color: #888; line-height: 1.5; margin-top: 4px;
    }
    .changelog-link {
      font-size: 11px; color: #36cfb4; text-decoration: none;
      white-space: nowrap; padding: 3px 8px; border: 1px solid rgba(54,207,180,0.2);
      border-radius: 4px; transition: all 0.15s;
    }
    .changelog-link:hover {
      background: rgba(54,207,180,0.1); border-color: #36cfb4;
    }

    /* Disclaimer & Features overlays (reuse changelog styles) */
    .disclaimer-overlay, .features-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); z-index: 200;
      display: none; align-items: center; justify-content: center;
    }
    .disclaimer-overlay.visible, .features-overlay.visible { display: flex; }
    .disclaimer-modal, .features-modal {
      background: #141414; border: 1px solid #2a2a2a; border-radius: 12px;
      width: 600px; max-width: 90vw; max-height: 80vh;
      display: flex; flex-direction: column; overflow: hidden;
    }
    .disclaimer-body, .features-body { padding: 16px 24px 24px; overflow-y: auto; flex: 1; }
    .disclaimer-body p { color: #aaa; font-size: 13px; line-height: 1.7; margin-bottom: 12px; }
    .disclaimer-body h3 { color: #36cfb4; font-size: 14px; margin: 16px 0 8px; }
    .disclaimer-body strong { color: #e0e0e0; }

    /* Features list */
    .feature-item {
      padding: 14px 16px; border-bottom: 1px solid #1e1e1e;
      display: flex; align-items: flex-start; gap: 12px;
    }
    .feature-item:last-child { border-bottom: none; }
    .feature-icon { font-size: 18px; flex-shrink: 0; margin-top: 2px; }
    .feature-info { flex: 1; }
    .feature-title { font-size: 14px; color: #e0e0e0; font-weight: 500; margin-bottom: 4px; }
    .feature-desc { font-size: 12px; color: #888; line-height: 1.5; }
    .coming-soon-badge {
      font-size: 10px; padding: 2px 8px; border-radius: 10px;
      background: rgba(248, 196, 113, 0.15); color: #f8c471;
      text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;
      flex-shrink: 0; margin-top: 4px;
    }

    /* Logout button */
    .logout-section { padding: 4px 14px; }
    .logout-section button {
      width: 100%; padding: 8px 16px; font-size: 13px;
      background: transparent; border: 1px solid #333;
      color: #999; border-radius: 8px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 6px;
      transition: all 0.2s;
    }
    .logout-section button:hover {
      border-color: #f87171; color: #f87171; background: rgba(248,113,113,0.06);
    }

    /* First-login disclaimer */
    .first-login-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 300;
      display: none; align-items: center; justify-content: center;
    }
    .first-login-overlay.visible { display: flex; }
    .first-login-modal {
      background: #141414; border: 1px solid #2a2a2a; border-radius: 12px;
      width: 560px; max-width: 90vw; max-height: 85vh;
      display: flex; flex-direction: column; overflow: hidden;
    }
    .first-login-body { padding: 16px 24px; overflow-y: auto; flex: 1; }
    .first-login-body p { color: #aaa; font-size: 13px; line-height: 1.7; margin-bottom: 12px; }
    .first-login-body strong { color: #e0e0e0; }
    .first-login-footer {
      padding: 16px 24px; border-top: 1px solid #2a2a2a;
      display: flex; align-items: center; gap: 12px;
    }
    .first-login-footer label { font-size: 13px; color: #ccc; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .first-login-footer input[type="checkbox"] { accent-color: #36cfb4; width: 16px; height: 16px; }
    .agree-btn {
      margin-left: auto; padding: 10px 24px; background: #333; border: 1px solid #444;
      color: #666; border-radius: 6px; font-size: 13px; font-weight: 600;
      cursor: not-allowed; transition: all 0.2s;
    }
    .agree-btn.enabled {
      background: #1a3a35; border-color: #36cfb4; color: #36cfb4; cursor: pointer;
    }
    .agree-btn.enabled:hover { background: #245a4a; }

    /* Animated loader (ghost bounce) */
    .ghost-loader {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; padding: 40px 20px; gap: 16px;
    }
    .ghost-loader .ghost-icon {
      animation: ghostBounce 1.4s ease-in-out infinite;
    }
    .ghost-loader .ghost-icon svg { width: 48px; height: 48px; fill: #36cfb4; opacity: 0.8; }
    .ghost-loader .loader-text { font-size: 13px; color: #888; }
    .ghost-loader .loader-dots::after { content: ''; animation: dots 1.5s infinite; }
    @keyframes ghostBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-12px); }
    }
    /* Fade-in animation for analytics/cost sections */
    .fade-in-section {
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 0.4s ease forwards;
    }
    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(0); }
    }

    /* Feedback tab chart bars */
    .fb-chart-bar-group { display: flex; align-items: flex-end; gap: 2px; }
    .fb-chart-bar {
      border-radius: 3px 3px 0 0; min-height: 2px; transition: height 0.3s;
    }
    .fb-chart-bar.up { background: #4CAF50; }
    .fb-chart-bar.down { background: #f87171; }
    .fb-chart-label { text-align: center; font-size: 9px; color: #888; margin-top: 4px; }

    /* Portfolio import drop zone */
    .drop-zone {
      border: 2px dashed #333; border-radius: 12px; padding: 48px 24px;
      text-align: center; cursor: pointer; transition: all 0.2s;
      background: #0f0f0f;
    }
    .drop-zone:hover, .drop-zone.drag-over {
      border-color: #36cfb4; background: rgba(54, 207, 180, 0.04);
    }
    .drop-zone .drop-icon { font-size: 48px; color: #333; margin-bottom: 12px; }
    .drop-zone.drag-over .drop-icon { color: #36cfb4; }
    .drop-zone .drop-text { font-size: 14px; color: #888; margin-bottom: 8px; }
    .drop-zone .drop-subtext { font-size: 12px; color: #555; }
    .drop-zone .drop-formats {
      display: flex; gap: 8px; justify-content: center; margin-top: 16px;
    }
    .drop-zone .format-badge {
      padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600;
      background: rgba(54, 207, 180, 0.08); color: #36cfb4; border: 1px solid rgba(54, 207, 180, 0.2);
    }
  </style>
</head>
<body>
  <header id="header" style="position: relative;">
    <a class="back" href="javascript:void(0)" id="ghostfolio-link">&#8592; Ghostfolio</a>
    <div class="header-left">
      <h1>Agent-Folio</h1>
    </div>
    <div class="header-center-logo" id="header-center-logo">
      <svg class="ghost-logo" viewBox="0 0 512 512" width="28" height="28" fill="#36cfb4"><path d="M255.633,0C145.341,0.198,55.994,89.667,55.994,200.006v278.66c0,14.849,17.953,22.285,28.453,11.786l38.216-39.328 l54.883,55.994c6.51,6.509,17.063,6.509,23.572,0L256,451.124l54.883,55.994c6.509,6.509,17.062,6.509,23.571,0l54.884-55.994 l38.216,39.327c10.499,10.499,28.453,3.063,28.453-11.786V201.719C456.006,91.512,365.84-0.197,255.633,0z M172.664,266.674 c-27.572,0-50.001-22.429-50.001-50.001s22.43-50.001,50.001-50.001s50.001,22.43,50.001,50.001S200.236,266.674,172.664,266.674z M339.336,266.674c-27.572,0-50.001-22.429-50.001-50.001s22.43-50.001,50.001-50.001s50.001,22.43,50.001,50.001 S366.908,266.674,339.336,266.674z"/></svg>
    </div>
    <div class="header-actions">
      <button onclick="newConversation()">+ New Chat</button>
      <span class="account-badge" id="account-badge" style="display:none;" onclick="toggleProfileDropdown(event)">
        <span id="badge-text"></span>
        <span class="backends-badge" id="backends-badge"></span>
      </span>
      <div class="profile-dropdown" id="profile-dropdown">
        <div class="pd-header">
          <div class="pd-name" id="pd-name">Account</div>
          <div class="pd-id" id="pd-id"></div>
        </div>
        <div class="pd-section-title">Connected Backends</div>
        <div id="pd-backends-list"></div>
        <button class="pd-add-btn" onclick="showAddBackendModal()">+ Add Backend</button>
        <div class="pd-footer">
          <button class="pd-settings-btn" onclick="toggleProfileDropdown(event); toggleSettings();">Settings</button>
          <button class="pd-signout-btn" onclick="doLogout()">Sign Out</button>
        </div>
      </div>
      <div class="status" id="status">Connected</div>
    </div>
  </header>

  <div class="main-content">
    <div id="sidebar">
      <div class="sidebar-header">
        <h3>Conversations</h3>
        <input class="sidebar-search" type="text" placeholder="Search conversations..." id="conv-search" oninput="filterConversations()" />
      </div>
      <div class="category-tabs" id="category-tabs">
        <span class="category-tab active" data-category="all" onclick="filterByCategory('all')">All</span>
        <span class="category-tab" data-category="portfolio" onclick="filterByCategory('portfolio')">Portfolio</span>
        <span class="category-tab" data-category="tax" onclick="filterByCategory('tax')">Tax</span>
        <span class="category-tab" data-category="risk" onclick="filterByCategory('risk')">Risk</span>
        <span class="category-tab" data-category="forecast" onclick="filterByCategory('forecast')">Forecast</span>
        <span class="category-tab" data-category="market" onclick="filterByCategory('market')">Market</span>
      </div>
      <div class="conv-list-area" id="conv-list"></div>
      <div class="help-section">
        <button id="help-fab" onclick="toggleHelpMenu()" title="Help & Info">?</button>
        <div id="help-menu">
          <div class="help-item" onclick="showChangelog()">
            <span class="help-icon">&#9998;</span> Changelog
          </div>
          <div class="help-item" onclick="showDisclaimer()">
            <span class="help-icon">&#9888;</span> Disclaimer
          </div>
          <div class="help-item" onclick="showFeatures()">
            <span class="help-icon">&#9733;</span> Discover Features
          </div>
          <div class="help-item" onclick="window.open('https://github.com/jpwilson/agent-folio','_blank')">
            <span class="help-icon">&#128279;</span> GitHub
          </div>
        </div>
      </div>
      <div class="logout-section">
        <button onclick="doLogout()">
          <span>&#x2192;</span> Sign Out
        </button>
      </div>
      <div class="admin-panel-toggle">
        <button onclick="toggleAdminPanel()">
          <span class="admin-icon">&#9881;</span>
          <span>Agent Admin</span>
        </button>
      </div>
    </div>
    <div id="chat-area">
      <div id="chat">
        <div class="welcome" id="welcome">
          <div class="logo-large"><svg viewBox="0 0 512 512" width="64" height="64" fill="#36cfb4"><path d="M255.633,0C145.341,0.198,55.994,89.667,55.994,200.006v278.66c0,14.849,17.953,22.285,28.453,11.786l38.216-39.328 l54.883,55.994c6.51,6.509,17.063,6.509,23.572,0L256,451.124l54.883,55.994c6.509,6.509,17.062,6.509,23.571,0l54.884-55.994 l38.216,39.327c10.499,10.499,28.453,3.063,28.453-11.786V201.719C456.006,91.512,365.84-0.197,255.633,0z M172.664,266.674 c-27.572,0-50.001-22.429-50.001-50.001s22.43-50.001,50.001-50.001s50.001,22.43,50.001,50.001S200.236,266.674,172.664,266.674z M339.336,266.674c-27.572,0-50.001-22.429-50.001-50.001s22.43-50.001,50.001-50.001s50.001,22.43,50.001,50.001 S366.908,266.674,339.336,266.674z"/></svg></div>
          <h2>Ask me about your portfolio</h2>
          <div>I can analyze your holdings, track performance, review transactions, assess risk, estimate taxes, and more.</div>
          <div class="suggestion-cats" id="suggestion-cats"></div>
          <div class="suggestions" id="suggestion-buttons"></div>
        </div>
      </div>
      <div id="followups-bar">
        <div class="followups-label" onclick="toggleFollowups()">
          <span class="arrow" id="followups-arrow">&#9660;</span> Suggested follow-ups
        </div>
        <div class="followups-list" id="followups-list"></div>
      </div>
      <div id="input-area">
        <input id="input" type="text" placeholder="Ask about your portfolio..." autofocus />
        <button id="send" onclick="send()">Send</button>
      </div>

    </div>
  </div>

  <!-- Changelog Overlay -->
  <div class="changelog-overlay" id="changelog-overlay" onclick="if(event.target===this)closeChangelog()">
    <div class="changelog-modal">
      <div class="changelog-header">
        <h2>Changelog</h2>
        <button class="changelog-close" onclick="closeChangelog()">&times;</button>
      </div>
      <div class="changelog-body" id="changelog-body"></div>
    </div>
  </div>

  <!-- Disclaimer Overlay -->
  <div class="disclaimer-overlay" id="disclaimer-overlay" onclick="if(event.target===this)closeDisclaimer()">
    <div class="disclaimer-modal">
      <div class="changelog-header">
        <h2>Financial Disclaimer</h2>
        <button class="changelog-close" onclick="closeDisclaimer()">&times;</button>
      </div>
      <div class="disclaimer-body" id="disclaimer-body">
        <p><strong>IMPORTANT: Please read this disclaimer carefully before using Agent-Folio.</strong></p>

        <h3>Not Financial Advice</h3>
        <p>Agent-Folio is an AI-powered informational tool that provides portfolio analysis and financial data summaries. <strong>Nothing provided by this application constitutes financial advice, investment advice, tax advice, legal advice, or any other form of professional advice.</strong></p>

        <h3>No Investment Recommendations</h3>
        <p>Agent-Folio does not recommend any specific investments, securities, or financial strategies. Any information about stocks, ETFs, bonds, or other financial instruments is provided for informational purposes only and should not be interpreted as a buy, sell, or hold recommendation.</p>

        <h3>Not a Registered Investment Advisor</h3>
        <p>Agent-Folio and its operators are <strong>not registered as investment advisors</strong> with the U.S. Securities and Exchange Commission (SEC), the Financial Industry Regulatory Authority (FINRA), or any state securities regulatory authority. This application does not operate under the Investment Advisers Act of 1940 or any equivalent regulation.</p>

        <h3>Accuracy of Information</h3>
        <p>While Agent-Folio strives to provide accurate portfolio analysis based on data from Ghostfolio, <strong>information may be incomplete, delayed, or inaccurate</strong>. AI-generated responses may contain errors or hallucinations. All data should be independently verified before making any financial decisions.</p>

        <h3>Risk Acknowledgment</h3>
        <p>All investments carry risk, including the potential loss of principal. Past performance is not indicative of future results. Tax estimates are approximations only and should not be used for tax filing purposes. Consult a qualified tax professional for tax advice.</p>

        <h3>Consult a Professional</h3>
        <p>Before making any investment decisions, you should consult with a qualified, licensed financial advisor, tax professional, or other appropriate professional who can consider your specific financial situation, goals, and risk tolerance.</p>

        <p style="margin-top: 20px; color: #666; font-size: 11px;">
          This application is provided "as is" without warranty of any kind. By using Agent-Folio, you acknowledge and accept the limitations described in this disclaimer.
        </p>
      </div>
    </div>
  </div>

  <!-- Discover Features Overlay -->
  <div class="features-overlay" id="features-overlay" onclick="if(event.target===this)closeFeatures()">
    <div class="features-modal">
      <div class="changelog-header">
        <h2>Discover Ghostfolio Features</h2>
        <button class="changelog-close" onclick="closeFeatures()">&times;</button>
      </div>
      <div class="features-body" id="features-body">
        <p style="color:#888; font-size:12px; margin-bottom:16px;">These powerful Ghostfolio features are being integrated into the AI assistant. Stay tuned!</p>
      </div>
    </div>
  </div>

  <!-- First-Login Disclaimer -->
  <div class="first-login-overlay" id="first-login-overlay">
    <div class="first-login-modal">
      <div class="changelog-header">
        <h2>Welcome to Agent-Folio</h2>
      </div>
      <div class="first-login-body">
        <p><strong>Before you begin, please review and accept our financial disclaimer.</strong></p>
        <p>Agent-Folio is an AI-powered informational tool. <strong>It does not provide financial advice, investment recommendations, or tax guidance.</strong></p>
        <p>All information is for educational and informational purposes only. AI-generated responses may contain errors. Always consult a qualified financial advisor before making investment decisions.</p>
        <p>Agent-Folio is not registered with the SEC, FINRA, or any regulatory authority under the Investment Advisers Act of 1940.</p>
        <p style="color:#666; font-size:11px;">You can review the full disclaimer at any time via the <strong>?</strong> menu.</p>
      </div>
      <div class="first-login-footer">
        <label>
          <input type="checkbox" id="disclaimer-agree-checkbox" onchange="onDisclaimerCheckbox(this.checked)" />
          I understand and accept this disclaimer
        </label>
        <button class="agree-btn" id="disclaimer-agree-btn" onclick="acceptDisclaimer()" disabled>Continue</button>
      </div>
    </div>
  </div>

  <!-- Login Overlay -->
  <div class="admin-overlay" id="login-overlay" style="display:none;">
    <div class="admin-modal" style="max-width: 400px;">
      <div class="admin-modal-header">
        <h2>Sign in to Agent-Folio</h2>
      </div>
      <div class="admin-modal-body" style="padding: 24px;">
        <p style="color: #999; font-size: 13px; margin-bottom: 16px;">
          Enter your Ghostfolio security token to authenticate. This is the same token you use to sign into Ghostfolio.
        </p>
        <div style="margin-bottom: 16px;">
          <label style="font-size: 12px; color: #999; display: block; margin-bottom: 6px;">Security Token</label>
          <input id="login-token" type="password" placeholder="Enter your security token..."
            style="width: 100%; padding: 10px 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 6px; color: #e0e0e0; font-size: 14px;" />
        </div>
        <div id="login-error" style="color: #ff4444; font-size: 12px; margin-bottom: 12px; display: none;"></div>
        <button id="login-btn" onclick="doLogin()"
          style="width: 100%; padding: 10px; background: #36cfb4; color: #000; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px;">
          Sign In
        </button>
        <div style="margin-top: 16px; text-align: center;">
          <a href="#" onclick="showManualToken(event)" style="color: #666; font-size: 11px; text-decoration: underline;">Or paste a JWT token directly</a>
        </div>
        <!-- Grader quick sign-in -->
        <div id="grader-section" style="display: none; margin-top: 20px; padding-top: 16px; border-top: 1px solid #2a2a2a;">
          <p style="color: #888; font-size: 11px; margin-bottom: 10px; text-align: center;">Demo Account</p>
          <button id="grader-btn" onclick="doGraderLogin()"
            style="width: 100%; padding: 10px; background: #1a1a1a; color: #36cfb4; border: 1px solid #36cfb4; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px; transition: background 0.2s;">
            Quick Sign-in for Grading
          </button>
          <p style="color: #555; font-size: 10px; margin-top: 6px; text-align: center;">
            Pre-seeded account with 5 years of diversified portfolio history
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Agent Admin Panel Modal -->
  <div class="admin-overlay" id="admin-overlay" onclick="if(event.target===this)toggleAdminPanel()">
    <div class="admin-modal">
      <div class="admin-modal-header">
        <h2>&#9881; Agent Admin <span class="admin-badge">Sidecar</span></h2>
        <button class="close-btn" onclick="toggleAdminPanel()">&times;</button>
      </div>
      <div class="admin-tabs">
        <div class="admin-tab active" data-tab="sdk" onclick="switchAdminTab('sdk')">SDK / Provider</div>
        <div class="admin-tab" data-tab="overview" onclick="switchAdminTab('overview')">Overview</div>
        <div class="admin-tab" data-tab="evals" onclick="switchAdminTab('evals'); loadEvalsTab();">Evaluations</div>
        <div class="admin-tab" data-tab="analytics" onclick="switchAdminTab('analytics'); loadTraces();">Analytics</div>
        <div class="admin-tab" data-tab="costs" onclick="switchAdminTab('costs'); loadCostAnalysis();">Cost Analysis</div>
      </div>
      <div class="admin-modal-body" id="admin-body">
        <!-- SDK / Provider tab -->
        <div id="admin-tab-sdk">
          <div class="admin-section">
            <h3>SDK Selection</h3>
            <div class="admin-card">
              <div style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: #999; display: block; margin-bottom: 6px;">Active SDK</label>
                <select class="admin-select" id="admin-sdk-select" onchange="onSdkChange()">
                </select>
                <div class="sdk-option-desc" id="sdk-desc"></div>
              </div>
            </div>
          </div>
          <div class="admin-section">
            <h3>Model Selection</h3>
            <div class="admin-card">
              <div style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: #999; display: block; margin-bottom: 6px;">Active Model</label>
                <select class="admin-select" id="admin-model-select" onchange="onModelChange()">
                </select>
                <div class="model-desc" id="model-desc"></div>
              </div>
            </div>
          </div>
          <div class="admin-section">
            <h3>API Keys</h3>
            <div class="admin-card">
              <div style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: #999; display: block; margin-bottom: 6px;">
                  OpenAI API Key <span id="openai-key-status" style="font-size: 10px;"></span>
                </label>
                <input class="admin-input" type="password" id="admin-openai-key" placeholder="sk-..." />
              </div>
              <div style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: #999; display: block; margin-bottom: 6px;">
                  Anthropic API Key <span id="anthropic-key-status" style="font-size: 10px;"></span>
                </label>
                <input class="admin-input" type="password" id="admin-anthropic-key" placeholder="sk-ant-..." />
              </div>
              <div style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: #999; display: block; margin-bottom: 6px;">
                  OpenRouter API Key <span id="openrouter-key-status" style="font-size: 10px;"></span>
                </label>
                <input class="admin-input" type="password" id="admin-openrouter-key" placeholder="sk-or-..." />
                <div style="font-size: 11px; color: #666; margin-top: 4px;">Bring your own key from <a href="https://openrouter.ai/keys" target="_blank" style="color: #36cfb4;">openrouter.ai</a>  access 100+ models</div>
              </div>
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <button class="admin-save-btn" id="admin-save-btn" onclick="saveAdminSettings()">Save Settings</button>
            <div class="settings-saved-msg" id="settings-saved-msg">Settings saved successfully!</div>
          </div>
        </div>
        <!-- Overview tab -->
        <div id="admin-tab-overview" style="display:none;">
          <div class="admin-stat-row">
            <div class="admin-stat">
              <div class="stat-value" id="stat-total-convos">--</div>
              <div class="stat-label">Total Conversations</div>
            </div>
            <div class="admin-stat">
              <div class="stat-value" id="stat-total-messages">--</div>
              <div class="stat-label">Total Messages</div>
            </div>
            <div class="admin-stat">
              <div class="stat-value" id="stat-tools-used">--</div>
              <div class="stat-label">Tool Calls</div>
            </div>
          </div>
          <div class="admin-section">
            <h3>Architecture</h3>
            <div class="admin-card">
              <div class="admin-list-item"><span class="label">Approach</span><span class="value">Sidecar (standalone)</span></div>
              <div class="admin-list-item"><span class="label">Backend</span><span class="value">FastAPI (Python)</span></div>
              <div class="admin-list-item"><span class="label">Ghostfolio</span><span class="value">Public REST API</span></div>
            </div>
          </div>
          <div class="admin-section">
            <h3>Category Distribution</h3>
            <div class="admin-card" id="admin-category-dist">
              <div class="admin-placeholder">Category stats will populate as conversations are classified</div>
            </div>
          </div>
        </div>
        <!-- Display tab -->
        <!-- Display tab moved to user Settings overlay -->
        <!-- Evals tab -->
        <div id="admin-tab-evals" style="display:none;">
          <div class="admin-section">
            <h3>Golden Set Evaluations</h3>
            <p style="color:#999; font-size:12px; margin-bottom:12px;">
              Two-step eval: <strong>Step 1</strong> generates snapshots by sending test cases to the live agent (costs tokens).
              <strong>Step 2</strong> runs deterministic checks against those snapshots (instant, no LLM calls).
            </p>
            <div style="display:flex; gap:8px; margin-bottom:16px;">
              <button id="eval-run-btn" onclick="runEvals()" style="padding:8px 16px; background:#36cfb4; color:#000; border:none; border-radius:6px; font-weight:600; cursor:pointer; font-size:13px;">
                Run Full Eval
              </button>
              <button id="eval-check-btn" onclick="runCheckOnly()" style="padding:8px 16px; background:#1a1a1a; color:#e0e0e0; border:1px solid #333; border-radius:6px; cursor:pointer; font-size:13px;">
                Re-run Checks Only
              </button>
            </div>
          </div>
          <!-- Progress -->
          <div id="eval-progress" style="display:none;" class="admin-section">
            <h3 id="eval-phase-title">Generating Snapshots...</h3>
            <p id="eval-phase-desc" style="color:#999; font-size:12px;"></p>
            <div style="background:#1a1a1a; border-radius:6px; overflow:hidden; height:6px; margin:8px 0;">
              <div id="eval-progress-bar" style="height:100%; background:#36cfb4; width:0%; transition:width 0.3s;"></div>
            </div>
            <div id="eval-progress-log" style="font-family:monospace; font-size:11px; color:#888; max-height:200px; overflow-y:auto; margin-top:8px;"></div>
          </div>
          <!-- Results -->
          <div id="eval-results" style="display:none;" class="admin-section">
            <h3>Results</h3>
            <div class="admin-card" style="margin-bottom:12px;">
              <div class="admin-list-item"><span class="label">Snapshots Generated</span><span class="value" id="eval-snap-time">--</span></div>
              <div class="admin-list-item"><span class="label">Total Eval Time</span><span class="value" id="eval-total-time">--</span></div>
              <div class="admin-list-item"><span class="label">Cases Passed</span><span class="value" id="eval-cases-pass">--</span></div>
              <div class="admin-list-item"><span class="label">Checks Passed</span><span class="value" id="eval-checks-pass">--</span></div>
            </div>
            <div id="eval-results-table"></div>
          </div>
          <!-- Eval History (collapsible, auto-loaded) -->
          <div class="admin-section" style="margin-top:16px;">
            <h3 onclick="toggleEvalHistory()" style="cursor:pointer; user-select:none;">
              <span id="eval-history-arrow">&#9654;</span> Eval History
            </h3>
            <div id="eval-history-content" style="display:none;"></div>
          </div>
          <!-- Agent Prompt Feedback (embedded in evals tab) -->
          <div class="admin-section" style="margin-top:24px; border-top:1px solid #333; padding-top:16px;">
            <h3>Agent Prompt Feedback</h3>
            <p style="color:#999; font-size:12px; margin-bottom:12px;">
              User satisfaction data from thumbs up/down interactions.
            </p>
            <div id="fbd-loading" style="display:none;">
              <div class="ghost-loader">
                <div class="ghost-icon"><svg viewBox="0 0 512 512"><path d="M255.633,0C145.341,0.198,55.994,89.667,55.994,200.006v278.66c0,14.849,17.953,22.285,28.453,11.786l38.216-39.328 l54.883,55.994c6.51,6.509,17.063,6.509,23.572,0L256,451.124l54.883,55.994c6.509,6.509,17.062,6.509,23.571,0l54.884-55.994 l38.216,39.327c10.499,10.499,28.453,3.063,28.453-11.786V201.719C456.006,91.512,365.84-0.197,255.633,0z M172.664,266.674 c-27.572,0-50.001-22.429-50.001-50.001s22.43-50.001,50.001-50.001s50.001,22.43,50.001,50.001S200.236,266.674,172.664,266.674z M339.336,266.674c-27.572,0-50.001-22.429-50.001-50.001s22.43-50.001,50.001-50.001s50.001,22.43,50.001,50.001 S366.908,266.674,339.336,266.674z"/></svg></div>
                <div class="loader-text">Loading feedback data<span class="loader-dots"></span></div>
              </div>
            </div>
            <div id="fbd-content" style="display:none;">
              <!-- KPI cards -->
              <div class="admin-stat-row" style="margin-bottom:12px;">
                <div class="admin-stat">
                  <div class="stat-value" id="fbd-total">--</div>
                  <div class="stat-label">Total Feedback</div>
                </div>
                <div class="admin-stat">
                  <div class="stat-value" style="color:#4CAF50;" id="fbd-up">--</div>
                  <div class="stat-label">Thumbs Up</div>
                </div>
                <div class="admin-stat">
                  <div class="stat-value" style="color:#f87171;" id="fbd-down">--</div>
                  <div class="stat-label">Thumbs Down</div>
                </div>
                <div class="admin-stat">
                  <div class="stat-value" style="color:#36cfb4;" id="fbd-rate">--</div>
                  <div class="stat-label">Satisfaction</div>
                </div>
              </div>
              <!-- Per-Conversation Breakdown -->
              <div class="admin-section">
                <h3 style="color:#36cfb4; font-size:13px; margin-bottom:8px;">Feedback by Conversation</h3>
                <div id="fbd-conv-table"></div>
              </div>
              <!-- Negative Feedback Reasons -->
              <div class="admin-section">
                <h3 style="color:#f87171; font-size:13px; margin-bottom:8px;">Thumbs Down Details</h3>
                <div id="fbd-negative-table"></div>
              </div>
              <!-- All Recent Entries -->
              <div class="admin-section">
                <h3 style="color:#36cfb4; font-size:13px; margin-bottom:8px;">Recent Feedback Log</h3>
                <div id="fbd-all-table"></div>
              </div>
            </div>
          </div>
        </div>
        <!-- Analytics tab (Langfuse tracing data) -->
        <div id="admin-tab-analytics" style="display:none;">
          <div class="admin-section">
            <h3>Analytics</h3>
            <p style="color:#999; font-size:12px; margin-bottom:12px;">
              LLM tracing and performance data from <strong>Langfuse</strong>. Shows latency, usage, and recent traces.
            </p>
            <button onclick="loadTraces()" style="padding:6px 14px; background:#1a1a1a; color:#e0e0e0; border:1px solid #333; border-radius:6px; cursor:pointer; font-size:12px; margin-bottom:12px;">
              Refresh
            </button>
          </div>
          <div id="traces-loading" style="display:none;">
            <div class="ghost-loader">
              <div class="ghost-icon"><svg viewBox="0 0 512 512"><path d="M255.633,0C145.341,0.198,55.994,89.667,55.994,200.006v278.66c0,14.849,17.953,22.285,28.453,11.786l38.216-39.328 l54.883,55.994c6.51,6.509,17.063,6.509,23.572,0L256,451.124l54.883,55.994c6.509,6.509,17.062,6.509,23.571,0l54.884-55.994 l38.216,39.327c10.499,10.499,28.453,3.063,28.453-11.786V201.719C456.006,91.512,365.84-0.197,255.633,0z M172.664,266.674 c-27.572,0-50.001-22.429-50.001-50.001s22.43-50.001,50.001-50.001s50.001,22.43,50.001,50.001S200.236,266.674,172.664,266.674z M339.336,266.674c-27.572,0-50.001-22.429-50.001-50.001s22.43-50.001,50.001-50.001s50.001,22.43,50.001,50.001 S366.908,266.674,339.336,266.674z"/></svg></div>
              <div class="loader-text">Loading analytics from Langfuse<span class="loader-dots"></span></div>
            </div>
          </div>
          <div id="traces-error" style="display:none;" class="admin-section"></div>
          <div id="traces-content" style="display:none;">
            <!-- KPI cards row -->
            <div class="admin-section" style="display:flex; gap:8px; flex-wrap:wrap;">
              <div class="admin-card" style="flex:1; min-width:100px; text-align:center; padding:12px;">
                <div style="font-size:20px; font-weight:700; color:#36cfb4;" id="t-avg-latency">--</div>
                <div style="font-size:10px; color:#888; margin-top:2px;">Avg Latency</div>
              </div>
              <div class="admin-card" style="flex:1; min-width:100px; text-align:center; padding:12px;">
                <div style="font-size:20px; font-weight:700; color:#36cfb4;" id="t-p95-latency">--</div>
                <div style="font-size:10px; color:#888; margin-top:2px;">P95 Latency</div>
              </div>
              <div class="admin-card" style="flex:1; min-width:100px; text-align:center; padding:12px;">
                <div style="font-size:20px; font-weight:700; color:#4CAF50;" id="t-success-rate">--</div>
                <div style="font-size:10px; color:#888; margin-top:2px;">Success Rate</div>
              </div>
              <div class="admin-card" style="flex:1; min-width:100px; text-align:center; padding:12px;">
                <div style="font-size:20px; font-weight:700; color:#e0e0e0;" id="t-total-traces">--</div>
                <div style="font-size:10px; color:#888; margin-top:2px;">Total Calls</div>
              </div>
            </div>
            <!-- Latency Distribution -->
            <div class="admin-section">
              <h3 style="color:#36cfb4; font-size:13px; margin-bottom:8px;">Latency Distribution</h3>
              <div id="t-latency-chart" style="display:flex; align-items:flex-end; gap:4px; height:100px; padding:0 4px;"></div>
              <div id="t-latency-labels" style="display:flex; gap:4px; padding:0 4px; margin-top:4px;"></div>
            </div>
            <!-- Daily Usage Chart -->
            <div class="admin-section">
              <h3 style="color:#36cfb4; font-size:13px; margin-bottom:8px;">Daily Usage</h3>
              <div id="t-daily-chart" style="display:flex; align-items:flex-end; gap:6px; height:80px; padding:0 4px;"></div>
              <div id="t-daily-labels" style="display:flex; gap:6px; padding:0 4px; margin-top:4px;"></div>
            </div>
            <!-- Latency Stats -->
            <div class="admin-section">
              <h3 style="color:#36cfb4; font-size:13px; margin-bottom:8px;">Performance Metrics</h3>
              <div class="admin-card">
                <div class="admin-list-item"><span class="label">Average Latency</span><span class="value" id="t-stat-avg">--</span></div>
                <div class="admin-list-item"><span class="label">Median (P50)</span><span class="value" id="t-stat-p50">--</span></div>
                <div class="admin-list-item"><span class="label">P95</span><span class="value" id="t-stat-p95">--</span></div>
                <div class="admin-list-item"><span class="label">Avg Time to First Token</span><span class="value" id="t-stat-ttft">--</span></div>
                <div class="admin-list-item"><span class="label">Successful Calls</span><span class="value" style="color:#4CAF50;" id="t-stat-success">--</span></div>
                <div class="admin-list-item"><span class="label">Failed Calls</span><span class="value" style="color:#ff4444;" id="t-stat-errors">--</span></div>
              </div>
            </div>
            <!-- Recent Traces -->
            <div class="admin-section">
              <h3 style="color:#36cfb4; font-size:13px; margin-bottom:8px;">Recent Traces</h3>
              <div id="t-recent-traces"></div>
            </div>
          </div>
        </div>
        <!-- Cost Analysis tab -->
        <div id="admin-tab-costs" style="display:none;">
          <div class="admin-section">
            <h3>AI Cost Analysis</h3>
            <p style="color:#999; font-size:12px; margin-bottom:12px;">
              Understanding AI costs is critical for production applications. Data sourced from <strong>Langfuse</strong> observability.
            </p>
            <button onclick="loadCostAnalysis()" style="padding:6px 14px; background:#1a1a1a; color:#e0e0e0; border:1px solid #333; border-radius:6px; cursor:pointer; font-size:12px; margin-bottom:12px;">
              Refresh Data
            </button>
          </div>
          <div id="costs-loading" style="display:none;">
            <div class="ghost-loader">
              <div class="ghost-icon"><svg viewBox="0 0 512 512"><path d="M255.633,0C145.341,0.198,55.994,89.667,55.994,200.006v278.66c0,14.849,17.953,22.285,28.453,11.786l38.216-39.328 l54.883,55.994c6.51,6.509,17.063,6.509,23.572,0L256,451.124l54.883,55.994c6.509,6.509,17.062,6.509,23.571,0l54.884-55.994 l38.216,39.327c10.499,10.499,28.453,3.063,28.453-11.786V201.719C456.006,91.512,365.84-0.197,255.633,0z M172.664,266.674 c-27.572,0-50.001-22.429-50.001-50.001s22.43-50.001,50.001-50.001s50.001,22.43,50.001,50.001S200.236,266.674,172.664,266.674z M339.336,266.674c-27.572,0-50.001-22.429-50.001-50.001s22.43-50.001,50.001-50.001s50.001,22.43,50.001,50.001 S366.908,266.674,339.336,266.674z"/></svg></div>
              <div class="loader-text">Loading cost data from Langfuse<span class="loader-dots"></span></div>
            </div>
          </div>
          <div id="costs-error" style="display:none;" class="admin-section"></div>
          <div id="costs-content" style="display:none;">
            <!-- Dev & Testing Costs -->
            <div class="admin-section">
              <h3 style="color:#36cfb4; font-size:13px; margin-bottom:8px;">Development & Testing Costs</h3>
              <div class="admin-card">
                <div class="admin-list-item"><span class="label">Total API Calls</span><span class="value" id="c-total-calls">--</span></div>
                <div class="admin-list-item"><span class="label">Total Input Tokens</span><span class="value" id="c-input-tokens">--</span></div>
                <div class="admin-list-item"><span class="label">Total Output Tokens</span><span class="value" id="c-output-tokens">--</span></div>
                <div class="admin-list-item"><span class="label">Total Tokens</span><span class="value" id="c-total-tokens">--</span></div>
                <div class="admin-list-item"><span class="label">LLM API Cost</span><span class="value" style="color:#36cfb4;" id="c-total-cost">--</span></div>
                <div class="admin-list-item"><span class="label">Observability Cost (Langfuse)</span><span class="value" id="c-obs-cost">--</span></div>
              </div>
            </div>
            <!-- By Model Breakdown -->
            <div class="admin-section">
              <h3 style="color:#36cfb4; font-size:13px; margin-bottom:8px;">Cost Breakdown by Model</h3>
              <div id="c-model-breakdown" class="admin-card"></div>
            </div>
            <!-- Production Cost Projections -->
            <div class="admin-section">
              <h3 style="color:#36cfb4; font-size:13px; margin-bottom:8px;">Production Cost Projections</h3>
              <div id="c-projections">
                <table style="width:100%; font-size:12px; border-collapse:collapse;">
                  <tr style="color:#999; text-align:center; border-bottom:1px solid #333;">
                    <th style="padding:8px;">100 Users</th>
                    <th style="padding:8px;">1,000 Users</th>
                    <th style="padding:8px;">10,000 Users</th>
                    <th style="padding:8px;">100,000 Users</th>
                  </tr>
                  <tr style="text-align:center;">
                    <td style="padding:8px; color:#36cfb4; font-weight:600; font-size:14px;" id="c-proj-100">--</td>
                    <td style="padding:8px; color:#36cfb4; font-weight:600; font-size:14px;" id="c-proj-1000">--</td>
                    <td style="padding:8px; color:#36cfb4; font-weight:600; font-size:14px;" id="c-proj-10000">--</td>
                    <td style="padding:8px; color:#36cfb4; font-weight:600; font-size:14px;" id="c-proj-100000">--</td>
                  </tr>
                </table>
              </div>
            </div>
            <!-- Assumptions -->
            <div class="admin-section">
              <h3 style="color:#888; font-size:12px; margin-bottom:6px;">Assumptions</h3>
              <div class="admin-card" style="font-size:11px; color:#666;" id="c-assumptions"></div>
            </div>
          </div>
        </div>
        <!-- Portfolio Import tab moved to user Settings overlay -->
      </div>
    </div>
  </div>

  <!-- User Settings Overlay -->
  <div class="admin-overlay" id="settings-overlay" onclick="if(event.target===this)toggleSettings()">
    <div class="admin-modal">
      <div class="admin-modal-header">
        <h2>Settings</h2>
        <button class="close-btn" onclick="toggleSettings()">&times;</button>
      </div>
      <div class="admin-tabs">
        <div class="admin-tab active" data-stab="profile" onclick="switchSettingsTab('profile')">Profile</div>
        <div class="admin-tab" data-stab="backends" onclick="switchSettingsTab('backends')">Backends</div>
        <div class="admin-tab" data-stab="display" onclick="switchSettingsTab('display')">Display</div>
        <div class="admin-tab" data-stab="import" onclick="switchSettingsTab('import'); loadImportHistory();">Import</div>
      </div>
      <div class="admin-modal-body">
        <!-- Profile tab -->
        <div id="settings-tab-profile">
          <div class="admin-section">
            <h3>Display Name</h3>
            <div class="admin-card">
              <div style="display:flex; gap:8px; align-items:center;">
                <input class="admin-input" type="text" id="settings-username" placeholder="Enter a display name..." style="flex:1;" />
                <button class="admin-save-btn" onclick="saveSettingsUsername()" style="padding:8px 16px; background:#36cfb4; color:#000; border:none; border-radius:6px; font-weight:600; cursor:pointer;">Save</button>
              </div>
              <div id="settings-name-saved" style="color:#36cfb4; font-size:12px; margin-top:6px; display:none;">Name updated!</div>
            </div>
          </div>
          <div class="admin-section">
            <h3>Account Info</h3>
            <div class="admin-card">
              <div class="admin-list-item"><span class="label">User ID</span><span class="value" id="settings-user-id" style="font-family:monospace; font-size:11px;">--</span></div>
            </div>
          </div>
        </div>
        <!-- Backends tab -->
        <div id="settings-tab-backends" style="display:none;">
          <div class="admin-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
              <h3 style="margin:0;">Connected Backends</h3>
              <button onclick="showAddBackendModal()" style="padding:6px 14px; background:transparent; border:1px solid #36cfb4; color:#36cfb4; border-radius:6px; font-size:12px; cursor:pointer;">+ Add Backend</button>
            </div>
            <div id="settings-backends-list">
              <div style="text-align:center; padding:24px; color:#888;">Loading...</div>
            </div>
          </div>
        </div>
        <!-- Display tab -->
        <div id="settings-tab-display" style="display:none;">
          <div class="admin-section">
            <h3>Response Rendering</h3>
            <div class="admin-card">
              <div class="admin-toggle-row">
                <div>
                  <div class="toggle-label">Render Markdown</div>
                  <div class="toggle-desc">Format agent responses with proper headings, tables, and lists</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="toggle-markdown" checked onchange="toggleSetting('markdown', this.checked)" />
                  <span class="slider"></span>
                </label>
              </div>
              <div class="admin-toggle-row">
                <div>
                  <div class="toggle-label">Show Tool Calls</div>
                  <div class="toggle-desc">Display which agent tools were used for each response</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="toggle-tools" checked onchange="toggleSetting('tools', this.checked)" />
                  <span class="slider"></span>
                </label>
              </div>
              <div class="admin-toggle-row">
                <div>
                  <div class="toggle-label">Show Verification</div>
                  <div class="toggle-desc">Display data verification checks on each response</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="toggle-verification" checked onchange="toggleSetting('verification', this.checked)" />
                  <span class="slider"></span>
                </label>
              </div>
              <div class="admin-toggle-row">
                <div>
                  <div class="toggle-label">Show Feedback Buttons</div>
                  <div class="toggle-desc">Show thumbs up/down on each agent response</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="toggle-feedback" checked onchange="toggleSetting('feedback', this.checked)" />
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>
        </div>
        <!-- Import tab -->
        <div id="settings-tab-import" style="display:none;">
          <div class="admin-section">
            <h3>Portfolio Import</h3>
            <p style="color:#999; font-size:12px; margin-bottom:16px;">
              Bring your data from another service. Upload your portfolio export file and we'll parse it into Ghostfolio format.
            </p>
          </div>
          <div class="admin-section">
            <div class="drop-zone" id="portfolio-drop-zone">
              <div class="drop-icon">&#128230;</div>
              <div class="drop-text">Drag & drop your portfolio file here</div>
              <div class="drop-subtext">or click to browse</div>
              <input type="file" id="portfolio-file-input" accept=".csv,.json" style="display:none;" />
              <div class="drop-formats">
                <span class="format-badge">CSV</span>
                <span class="format-badge">JSON</span>
              </div>
            </div>
          </div>
          <div id="portfolio-file-info" style="display:none;" class="admin-section">
            <div class="admin-card" style="display:flex; align-items:center; gap:12px;">
              <div style="font-size:24px;">&#128196;</div>
              <div style="flex:1;">
                <div style="font-size:13px; color:#e0e0e0; font-weight:500;" id="portfolio-file-name">--</div>
                <div style="font-size:11px; color:#888;" id="portfolio-file-size">--</div>
              </div>
              <button onclick="clearPortfolioFile()" style="padding:6px 12px; background:#1a1a1a; border:1px solid #333; color:#999; border-radius:6px; font-size:12px; cursor:pointer;">Remove</button>
            </div>
          </div>
          <div class="admin-section">
            <h3 style="color:#888; font-size:12px; margin-bottom:8px;">Supported Sources</h3>
            <div class="admin-card">
              <div class="admin-list-item"><span class="label">Interactive Brokers</span><span class="value" style="color:#36cfb4;">CSV</span></div>
              <div class="admin-list-item"><span class="label">Trading 212</span><span class="value" style="color:#36cfb4;">CSV</span></div>
              <div class="admin-list-item"><span class="label">Degiro</span><span class="value" style="color:#36cfb4;">CSV / XLS</span></div>
              <div class="admin-list-item"><span class="label">Robinhood</span><span class="value" style="color:#36cfb4;">CSV</span></div>
              <div class="admin-list-item"><span class="label">Ghostfolio Export</span><span class="value" style="color:#36cfb4;">JSON</span></div>
              <div class="admin-list-item"><span class="label">Custom Format</span><span class="value" style="color:#888;">Coming Soon</span></div>
            </div>
          </div>
          <div id="portfolio-preview" style="display:none;" class="admin-section"></div>
          <div class="admin-section" style="margin-top:16px; border-top:1px solid #333; padding-top:16px;">
            <h3>Upload History</h3>
            <div id="portfolio-history" style="display:none;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // API base  agent-folio's own API
    const API_BASE = '/api/v1/agent';
    const centerLogo = document.getElementById('header-center-logo');
    const headerEl = document.getElementById('header');

    // Settings (persisted to localStorage)
    const defaultSettings = { markdown: true, tools: true, verification: true, feedback: true };
    let settings = { ...defaultSettings };
    try {
      const saved = JSON.parse(localStorage.getItem('agent-settings'));
      if (saved) settings = { ...defaultSettings, ...saved };
    } catch {}

    function applySettings() {
      document.body.classList.toggle('hide-tools', !settings.tools);
      document.body.classList.toggle('hide-verification', !settings.verification);
      document.body.classList.toggle('hide-feedback', !settings.feedback);
      const mt = document.getElementById('toggle-markdown');
      const tt = document.getElementById('toggle-tools');
      const vt = document.getElementById('toggle-verification');
      const ft = document.getElementById('toggle-feedback');
      if (mt) mt.checked = settings.markdown;
      if (tt) tt.checked = settings.tools;
      if (vt) vt.checked = settings.verification;
      if (ft) ft.checked = settings.feedback;
    }

    function toggleSetting(key, value) {
      settings[key] = value;
      localStorage.setItem('agent-settings', JSON.stringify(settings));
      applySettings();
      if (key === 'markdown') rerenderMessages();
    }

    function rerenderMessages() {
      document.querySelectorAll('.message.assistant .msg-content').forEach(el => {
        const raw = el.getAttribute('data-raw');
        if (raw) {
          if (settings.markdown && typeof marked !== 'undefined') {
            el.innerHTML = marked.parse(raw);
            renderCharts(el);
            el.classList.remove('raw');
          } else {
            el.textContent = raw;
            el.classList.add('raw');
          }
        }
      });
    }

    applySettings();

    function getToken() {
      return sessionStorage.getItem('auth-token') || localStorage.getItem('auth-token') || '';
    }

    function setChatMode(active) {
      if (active) {
        centerLogo.classList.add('visible');
        headerEl.classList.add('chat-active');
      } else {
        centerLogo.classList.remove('visible');
        headerEl.classList.remove('chat-active');
      }
    }

    let TOKEN = getToken();
    let IS_GRADER = sessionStorage.getItem('is-grader') === 'true';
    let messages = [];
    let currentConversationId = null;
    let allConversations = [];
    let activeCategory = 'all';
    let isLoadingConversations = false;
    let _profileUserId = '';
    let _profileShortId = '';
    let _profileUsername = null;

    const statusEl = document.getElementById('status');
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const convListEl = document.getElementById('conv-list');
    const convSearchEl = document.getElementById('conv-search');

    if (!TOKEN) {
      showLoginOverlay();
    } else {
      onAuthenticated();
    }

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
    });

    document.getElementById('login-token').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') doLogin();
    });

    function showLoginOverlay() {
      statusEl.textContent = 'Not authenticated';
      statusEl.className = 'status disconnected';
      document.getElementById('login-overlay').style.display = 'flex';
      checkGraderAvailable();
    }

    async function doLogin() {
      const tokenInput = document.getElementById('login-token');
      const errorEl = document.getElementById('login-error');
      const btn = document.getElementById('login-btn');
      const securityToken = tokenInput.value.trim();
      if (!securityToken) return;

      btn.textContent = 'Signing in...';
      btn.disabled = true;
      errorEl.style.display = 'none';

      try {
        const res = await fetch(`${API_BASE}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ securityToken })
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.detail || 'Authentication failed');
        }
        const data = await res.json();
        TOKEN = data.authToken;
        IS_GRADER = false;
        sessionStorage.setItem('auth-token', TOKEN);
        sessionStorage.setItem('is-grader', 'false');
        document.getElementById('login-overlay').style.display = 'none';
        onAuthenticated();
      } catch (err) {
        errorEl.textContent = err.message;
        errorEl.style.display = 'block';
      } finally {
        btn.textContent = 'Sign In';
        btn.disabled = false;
      }
    }

    function showManualToken(e) {
      e.preventDefault();
      const t = prompt('Paste your JWT token:');
      if (t) {
        TOKEN = t;
        IS_GRADER = false;
        sessionStorage.setItem('auth-token', TOKEN);
        sessionStorage.setItem('is-grader', 'false');
        document.getElementById('login-overlay').style.display = 'none';
        onAuthenticated();
      }
    }

    async function checkGraderAvailable() {
      try {
        const res = await fetch(`${API_BASE}/auth/grader-available`);
        const data = await res.json();
        const section = document.getElementById('grader-section');
        if (section) section.style.display = data.available ? 'block' : 'none';
      } catch { /* ignore */ }
    }

    async function doGraderLogin() {
      const btn = document.getElementById('grader-btn');
      const errorEl = document.getElementById('login-error');
      btn.textContent = 'Signing in as grader...';
      btn.disabled = true;
      errorEl.style.display = 'none';
      try {
        const res = await fetch(`${API_BASE}/auth/grader-login`, { method: 'POST' });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.detail || 'Grader login failed');
        }
        const data = await res.json();
        TOKEN = data.authToken;
        IS_GRADER = true;
        sessionStorage.setItem('auth-token', TOKEN);
        sessionStorage.setItem('is-grader', 'true');
        document.getElementById('login-overlay').style.display = 'none';
        onAuthenticated();
      } catch (err) {
        errorEl.textContent = err.message;
        errorEl.style.display = 'block';
      } finally {
        btn.textContent = 'Quick Sign-in for Grading';
        btn.disabled = false;
      }
    }

    function onAuthenticated() {
      statusEl.textContent = 'Connected';
      statusEl.className = 'status connected';
      updateAccountBadge();
      loadConversations();
      loadSdkSettings();
      loadConfig();
    }

    async function updateAccountBadge() {
      const badge = document.getElementById('account-badge');
      const badgeText = document.getElementById('badge-text');
      if (!badge || !TOKEN) { console.warn('[badge] no badge element or TOKEN'); return; }

      // Always show the badge  populate with best-effort data
      badge.style.display = 'inline-flex';
      badge.style.alignItems = 'center';
      badge.style.gap = '4px';

      try {
        const parts = TOKEN.split('.');
        const payload = JSON.parse(atob(parts[1] + '=='.slice((2 - parts[1].length * 3) & 3)));
        _profileUserId = payload.id || payload.sub || '';
        _profileShortId = _profileUserId.substring(0, 8);
      } catch (e) {
        console.warn('[badge] JWT decode failed:', e.message);
        _profileUserId = '';
        _profileShortId = '';
      }

      if (IS_GRADER) {
        badgeText.textContent = 'Grader';
        badge.className = 'account-badge grader';
        badge.title = 'Demo grader account';
      } else {
        try {
          const res = await fetch(`${API_BASE}/profile`, {
            headers: { 'Authorization': `Bearer ${TOKEN}` }
          });
          if (res.ok) _profileUsername = (await res.json()).username;
        } catch {}
        badgeText.textContent = _profileUsername || ('Account ' + _profileShortId) || 'Account';
        badge.className = 'account-badge';
        badge.title = 'Profile & Backends';
      }
      badge.style.cursor = 'pointer';

      // Load backends badge count (best-effort)
      try { await loadBackendsList(); } catch {}
    }

    function toggleProfileDropdown(e) {
      if (e) e.stopPropagation();
      const dd = document.getElementById('profile-dropdown');
      dd.classList.toggle('visible');
      if (dd.classList.contains('visible')) {
        document.getElementById('pd-name').textContent = _profileUsername || ('Account ' + _profileShortId);
        document.getElementById('pd-id').textContent = _profileUserId;
        loadBackendsList();
      }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const dd = document.getElementById('profile-dropdown');
      const badge = document.getElementById('account-badge');
      if (dd && dd.classList.contains('visible') && !badge.contains(e.target) && !dd.contains(e.target)) {
        dd.classList.remove('visible');
      }
    });

    async function loadBackendsList() {
      try {
        const res = await fetch(`${API_BASE}/backends`, {
          headers: { 'Authorization': `Bearer ${TOKEN}` }
        });
        if (!res.ok) return;
        const data = await res.json();
        const backends = data.backends || [];
        const container = document.getElementById('pd-backends-list');
        const backendsBadge = document.getElementById('backends-badge');

        // Update header badge
        const activeBackends = backends.filter(b => b.isActive);
        if (activeBackends.length > 0) {
          const names = activeBackends.map(b => b.provider.charAt(0).toUpperCase() + b.provider.slice(1));
          backendsBadge.textContent = '(' + names.join(' + ') + ')';
        } else {
          backendsBadge.textContent = '';
        }

        if (backends.length === 0) {
          container.innerHTML = '<div style="padding: 8px 16px; font-size: 12px; color: #666;">No backends connected</div>';
          return;
        }

        container.innerHTML = backends.map(b => `
          <div class="pd-backend">
            <span class="pd-be-provider">${b.provider}</span>
            <div class="pd-be-info">
              <span class="pd-be-label">${b.label || b.provider}</span>
              <span class="pd-be-url">${b.baseUrl}</span>
            </div>
            <button class="pd-be-toggle ${b.isActive ? 'active' : 'inactive'}"
                    title="${b.isActive ? 'Active' : 'Inactive'}"
                    onclick="toggleBackend('${b.id}', ${!b.isActive})"></button>
            <div class="pd-be-actions">
              <button onclick="testBackend('${b.id}')" title="Test connection">&#9889;</button>
              <button onclick="deleteBackend('${b.id}')" title="Remove">&#10005;</button>
            </div>
          </div>
        `).join('');
      } catch {}
    }

    async function toggleBackend(id, newActive) {
      try {
        await fetch(`${API_BASE}/backends/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` },
          body: JSON.stringify({ isActive: newActive })
        });
        await loadBackendsList();
        await loadSettingsBackends();
      } catch {}
    }

    async function testBackend(id) {
      try {
        const res = await fetch(`${API_BASE}/backends/${id}/test`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${TOKEN}` }
        });
        const data = await res.json();
        alert(data.message || (data.success ? 'Connected!' : 'Failed'));
      } catch (e) {
        alert('Test failed: ' + e.message);
      }
    }

    async function deleteBackend(id) {
      if (!confirm('Remove this backend connection?')) return;
      try {
        await fetch(`${API_BASE}/backends/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${TOKEN}` }
        });
        await loadBackendsList();
        await loadSettingsBackends();
      } catch {}
    }

    function showAddBackendModal() {
      document.getElementById('add-backend-modal').classList.add('visible');
      onProviderChange();
    }

    function hideAddBackendModal() {
      document.getElementById('add-backend-modal').classList.remove('visible');
      document.getElementById('abm-label').value = '';
      document.getElementById('abm-url').value = '';
      document.getElementById('abm-security-token').value = '';
      document.getElementById('abm-username').value = '';
      document.getElementById('abm-password').value = '';
    }

    function onProviderChange() {
      const provider = document.getElementById('abm-provider').value;
      const isGF = provider === 'ghostfolio';
      document.getElementById('abm-cred-token-field').style.display = isGF ? 'block' : 'none';
      document.getElementById('abm-cred-user-field').style.display = isGF ? 'none' : 'block';
      document.getElementById('abm-cred-pass-field').style.display = isGF ? 'none' : 'block';
      document.getElementById('abm-url').placeholder = isGF ? 'http://localhost:3333' : 'http://localhost:4242';
    }

    async function saveBackend() {
      const provider = document.getElementById('abm-provider').value;
      const label = document.getElementById('abm-label').value;
      const baseUrl = document.getElementById('abm-url').value;
      if (!baseUrl) { alert('URL is required'); return; }

      let credentials = {};
      if (provider === 'ghostfolio') {
        const token = document.getElementById('abm-security-token').value;
        if (!token) { alert('Security token is required'); return; }
        credentials = { security_token: token };
      } else {
        const username = document.getElementById('abm-username').value;
        const password = document.getElementById('abm-password').value;
        if (!username || !password) { alert('Username and password are required'); return; }
        credentials = { username, password };
      }

      try {
        const res = await fetch(`${API_BASE}/backends`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` },
          body: JSON.stringify({ provider, label, baseUrl, credentials })
        });
        if (res.ok) {
          hideAddBackendModal();
          await loadBackendsList();
          await loadSettingsBackends();
        } else {
          const data = await res.json();
          alert(data.detail || 'Failed to add backend');
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    let ghostfolioBaseUrl = '';

    async function loadConfig() {
      try {
        const res = await fetch(`${API_BASE}/config`);
        if (res.ok) {
          const data = await res.json();
          if (data.ghostfolioUrl) {
            ghostfolioBaseUrl = data.ghostfolioUrl.replace(/\/$/, '');
          }
          const link = document.getElementById('ghostfolio-link');
          if (link) {
            link.onclick = function(e) {
              e.preventDefault();
              goToGhostfolio();
            };
          }
        }
      } catch {}
    }

    function goToGhostfolio() {
      if (!ghostfolioBaseUrl) return;
      const jwt = sessionStorage.getItem('auth-token');
      if (jwt) {
        // Navigate to Ghostfolio with auth  logs in as the current user
        window.location.href = `${ghostfolioBaseUrl}/en/auth/${jwt}`;
      } else {
        window.location.href = `${ghostfolioBaseUrl}/en/home`;
      }
    }

    function classifyConversation(title) {
      if (!title) return 'general';
      const t = title.toLowerCase();
      if (t.includes('tax') || t.includes('capital gain') || t.includes('tax bill')) return 'tax';
      if (t.includes('risk') || t.includes('risky') || t.includes('volatil') || t.includes('diversif')) return 'risk';
      if (t.includes('forecast') || t.includes('predict') || t.includes('what if') || t.includes('scenario')) return 'forecast';
      if (t.includes('market') || t.includes('sector') || t.includes('index') || t.includes('s&p')) return 'market';
      if (t.includes('portfolio') || t.includes('holding') || t.includes('bought') || t.includes('allocation') || t.includes('position') || t.includes('stock') || t.includes('heavy') || t.includes('look like')) return 'portfolio';
      return 'general';
    }

    function filterConversations() {
      const query = convSearchEl.value.toLowerCase().trim();
      const items = convListEl.querySelectorAll('.conv-item');
      items.forEach(item => {
        const title = (item.getAttribute('data-title') || '').toLowerCase();
        const category = item.getAttribute('data-category') || '';
        const matchesSearch = !query || title.includes(query);
        const matchesCategory = activeCategory === 'all' || category === activeCategory;
        item.classList.toggle('hidden', !(matchesSearch && matchesCategory));
      });
    }

    function filterByCategory(cat) {
      activeCategory = cat;
      document.querySelectorAll('.category-tab').forEach(el => {
        el.classList.toggle('active', el.getAttribute('data-category') === cat);
      });
      filterConversations();
    }

    async function loadConversations() {
      if (!TOKEN || isLoadingConversations) return;
      isLoadingConversations = true;
      try {
        const res = await fetch(`${API_BASE}/conversations`, {
          headers: { 'Authorization': `Bearer ${TOKEN}` }
        });
        if (!res.ok) return;
        const data = await res.json();
        allConversations = data.conversations || [];
        const seen = new Set();
        allConversations = allConversations.filter(c => {
          if (seen.has(c.id)) return false;
          seen.add(c.id);
          return true;
        });
        renderConversationList(allConversations);
      } catch (e) {}
      finally { isLoadingConversations = false; }
    }

    function renderConversationList(conversations) {
      convListEl.innerHTML = '';
      for (const conv of conversations) {
        const category = classifyConversation(conv.title);
        const div = document.createElement('div');
        div.className = 'conv-item' + (conv.id === currentConversationId ? ' active' : '');
        div.setAttribute('data-title', conv.title || '');
        div.setAttribute('data-category', category);
        div.setAttribute('data-id', conv.id);
        const dateStr = new Date(conv.updatedAt).toLocaleDateString();
        div.innerHTML = `
          <span class="conv-delete" onclick="event.stopPropagation(); deleteConversation('${conv.id}')">&#10005;</span>
          <div>${conv.title || 'Untitled'}<span class="conv-category">${category}</span></div>
          <div class="conv-date">${dateStr} &middot; ${conv._count?.messages || 0} msgs</div>
        `;
        div.addEventListener('click', () => loadConversation(conv.id));
        convListEl.appendChild(div);
      }
      filterConversations();
    }

    async function loadConversation(id) {
      if (!TOKEN) return;
      try {
        const res = await fetch(`${API_BASE}/conversations/${id}`, {
          headers: { 'Authorization': `Bearer ${TOKEN}` }
        });
        if (!res.ok) return;
        const data = await res.json();
        if (!data.conversation) return;
        currentConversationId = id;
        messages = [];
        chat.innerHTML = '';
        setChatMode(true);
        let lastFollowups = null;
        let lastToolCalls = null;
        for (const msg of data.conversation.messages) {
          messages.push({ role: msg.role, content: msg.content });
          addMessage(msg.content, msg.role, msg.toolCalls);
          if (msg.role === 'assistant') {
            lastFollowups = msg.followups;
            lastToolCalls = msg.toolCalls;
          }
        }
        // Show follow-ups from the last assistant message
        showFollowups(lastToolCalls, lastFollowups);
        document.querySelectorAll('.conv-item').forEach(el => {
          el.classList.toggle('active', el.getAttribute('data-id') === id);
        });
      } catch (e) {}
    }

    async function deleteConversation(id) {
      if (!confirm('Delete this conversation?')) return;
      try {
        await fetch(`${API_BASE}/conversations/${id}`, {
          method: 'DELETE', headers: { 'Authorization': `Bearer ${TOKEN}` }
        });
        if (id === currentConversationId) newConversation();
        loadConversations();
      } catch (e) {}
    }

    function newConversation() {
      currentConversationId = null;
      messages = [];
      setChatMode(false);
      const fbar = document.getElementById('followups-bar');
      if (fbar) fbar.classList.remove('visible');
      chat.innerHTML = `
        <div class="welcome" id="welcome">
          <div class="logo-large"><svg viewBox="0 0 512 512" width="64" height="64" fill="#36cfb4"><path d="M255.633,0C145.341,0.198,55.994,89.667,55.994,200.006v278.66c0,14.849,17.953,22.285,28.453,11.786l38.216-39.328 l54.883,55.994c6.51,6.509,17.063,6.509,23.572,0L256,451.124l54.883,55.994c6.509,6.509,17.062,6.509,23.571,0l54.884-55.994 l38.216,39.327c10.499,10.499,28.453,3.063,28.453-11.786V201.719C456.006,91.512,365.84-0.197,255.633,0z M172.664,266.674 c-27.572,0-50.001-22.429-50.001-50.001s22.43-50.001,50.001-50.001s50.001,22.43,50.001,50.001S200.236,266.674,172.664,266.674z M339.336,266.674c-27.572,0-50.001-22.429-50.001-50.001s22.43-50.001,50.001-50.001s50.001,22.43,50.001,50.001 S366.908,266.674,339.336,266.674z"/></svg></div>
          <h2>Ask me about your portfolio</h2>
          <div>I can analyze your holdings, track performance, review transactions, assess risk, estimate taxes, and more.</div>
          <div class="suggestion-cats" id="suggestion-cats"></div>
          <div class="suggestions" id="suggestion-buttons"></div>
        </div>
      `;
      initSuggestionCategories();
      document.querySelectorAll('.conv-item').forEach(el => el.classList.remove('active'));
    }

    function sendSuggestion(text) { input.value = text; send(); }

    function addProgressStep(container, text, isActive) {
      const step = document.createElement('div');
      step.className = 'progress-step' + (isActive ? ' active' : '');
      step.innerHTML = `<div class="spinner"></div><span>${text}</span>`;
      container.appendChild(step);
      chat.scrollTop = chat.scrollHeight;
      return step;
    }

    function completeProgressStep(step) {
      if (step) {
        step.classList.remove('active');
        step.classList.add('done');
      }
    }

    function toolDisplayName(tool, args) {
      const names = {
        portfolio_summary: 'Fetching portfolio',
        market_data: 'Looking up',
        stock_history: 'Fetching price history for',
        transaction_history: 'Loading transactions',
        risk_assessment: 'Analyzing risk',
        tax_estimate: 'Calculating taxes',
        portfolio_performance: 'Loading performance',
        dividend_history: 'Loading dividends',
        portfolio_report: 'Running health check',
        investment_timeline: 'Loading investments',
        account_overview: 'Loading accounts',
      };
      let label = names[tool] || `Running ${tool}`;
      if (args?.query) label += ` ${args.query}`;
      if (args?.dateRange) label += ` (${args.dateRange})`;
      return label;
    }

    async function send() {
      const text = input.value.trim();
      if (!text) return;
      if (!TOKEN) TOKEN = getToken();
      if (!TOKEN) { addMessage('Please provide a JWT token to authenticate.', 'error'); return; }
      const welcome = chat.querySelector('.welcome');
      if (welcome) { welcome.remove(); setChatMode(true); }
      addMessage(text, 'user');
      messages.push({ role: 'user', content: text });
      input.value = '';
      sendBtn.disabled = true;

      // Progressive disclosure container
      const progress = document.createElement('div');
      progress.className = 'progress-bar';
      let currentStep = addProgressStep(progress, 'Analyzing your request...', true);
      let currentStepText = 'Analyzing your request...';
      chat.appendChild(progress);
      chat.scrollTop = chat.scrollHeight;

      try {
        const res = await fetch(`${API_BASE}/chat/stream`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` },
          body: JSON.stringify({ messages, conversationId: currentConversationId })
        });

        if (!res.ok) {
          progress.remove();
          const err = await res.text();
          addMessage(`Error ${res.status}: ${err}`, 'error');
          sendBtn.disabled = false;
          return;
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let finalData = null;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });

          // Parse SSE events from buffer
          const lines = buffer.split('\n');
          buffer = lines.pop() || '';

          let eventType = null;
          let eventData = null;

          for (const line of lines) {
            if (line.startsWith('event: ')) {
              eventType = line.slice(7).trim();
            } else if (line.startsWith('data: ')) {
              eventData = line.slice(6);
              // Process the event
              if (eventType && eventData) {
                try {
                  const parsed = JSON.parse(eventData);
                  if (eventType === 'status') {
                    // Skip if same text as current step (avoids duplicate)
                    if (parsed.text !== currentStepText) {
                      completeProgressStep(currentStep);
                      currentStep = addProgressStep(progress, parsed.text, true);
                      currentStepText = parsed.text;
                    }
                  } else if (eventType === 'tool_start') {
                    completeProgressStep(currentStep);
                    const label = toolDisplayName(parsed.tool, parsed.args);
                    currentStep = addProgressStep(progress, label, true);
                    currentStepText = label;
                  } else if (eventType === 'tool_done') {
                    // Step already active, mark complete  next event will add new one
                  } else if (eventType === 'complete') {
                    finalData = parsed;
                  }
                } catch {}
              }
              eventType = null;
              eventData = null;
            }
          }
        }

        progress.remove();

        if (finalData) {
          if (finalData.conversationId) {
            currentConversationId = finalData.conversationId;
            loadConversations();
          }
          messages.push({ role: 'assistant', content: finalData.message });
          addMessage(finalData.message, 'assistant', finalData.toolCalls, finalData.verification, true);
          showFollowups(finalData.toolCalls, finalData.followups);
        } else {
          addMessage('No response received.', 'error');
        }
      } catch (err) {
        progress.remove();
        addMessage(`Network error: ${err.message}`, 'error');
      }
      sendBtn.disabled = false;
      input.focus();
    }

    // ---- Categorized Suggestions ----
    const SUGGESTION_CATEGORIES = {
      'All': [
        // First 2: single-tool | Next 2: multi-tool
        { q: 'What does my portfolio look like?', tools: 'portfolio_summary', type: 'single' },
        { q: 'What have I bought recently?', tools: 'transaction_history', type: 'single' },
        { q: 'Show my portfolio allocation and how it performed this year', tools: 'portfolio_summary + portfolio_performance', type: 'multi' },
        { q: 'How risky is my portfolio and what\'s my tax situation?', tools: 'risk_assessment + tax_estimate', type: 'multi' },
      ],
      'Portfolio': [
        { q: 'What does my portfolio look like?', type: 'single' },
        { q: 'What percentage is each stock?', type: 'single' },
        { q: 'Give me a complete breakdown of my holdings with values', type: 'single' },
        { q: 'Am I too heavy in tech stocks?', type: 'single' },
      ],
      'Performance': [
        { q: 'How has my portfolio performed this year?', type: 'single' },
        { q: 'Show me my portfolio performance since inception', type: 'single' },
        { q: 'What are my annualized returns?', type: 'single' },
        { q: 'Compare my YTD vs 1-year performance', type: 'multi' },
      ],
      'Tax': [
        { q: 'What are my unrealized gains?', type: 'single' },
        { q: 'What\'s my estimated tax bill?', type: 'single' },
        { q: 'Show my cost basis for each holding', type: 'single' },
        { q: 'Which positions have the biggest gains?', type: 'single' },
      ],
      'Risk': [
        { q: 'How risky is my portfolio?', type: 'single' },
        { q: 'How diversified am I across sectors?', type: 'single' },
        { q: 'Run a health check on my portfolio', type: 'single' },
        { q: 'Analyze my risk and show which sectors I\'m overweight in', type: 'multi' },
      ],
      'Income': [
        { q: 'How much dividend income have I earned?', type: 'single' },
        { q: 'Show my dividends by month this year', type: 'single' },
        { q: 'What\'s my investment timeline?', type: 'single' },
        { q: 'Show my dividend income and portfolio performance together', type: 'multi' },
      ],
      'Accounts': [
        { q: 'What accounts do I have?', type: 'single' },
        { q: 'Show me my account balances', type: 'single' },
        { q: 'What platforms are my investments on?', type: 'single' },
        { q: 'Overview my accounts and total holdings', type: 'multi' },
      ],
    };

    let activeSuggestionCat = 'All';

    function initSuggestionCategories() {
      const catsEl = document.getElementById('suggestion-cats');
      const btnsEl = document.getElementById('suggestion-buttons');
      if (!catsEl || !btnsEl) return;
      catsEl.innerHTML = Object.keys(SUGGESTION_CATEGORIES).map(cat =>
        `<span class="suggestion-cat-btn${cat === activeSuggestionCat ? ' active' : ''}" onclick="switchSuggestionCat('${cat}')">${cat}</span>`
      ).join('');
      renderSuggestionButtons(activeSuggestionCat);
    }

    function switchSuggestionCat(cat) {
      activeSuggestionCat = cat;
      document.querySelectorAll('.suggestion-cat-btn').forEach(el => {
        el.classList.toggle('active', el.textContent === cat);
      });
      renderSuggestionButtons(cat);
    }

    function renderSuggestionButtons(cat) {
      const btnsEl = document.getElementById('suggestion-buttons');
      if (!btnsEl) return;
      const items = SUGGESTION_CATEGORIES[cat] || [];
      btnsEl.innerHTML = items.map(item =>
        `<button onclick="sendSuggestion(this.getAttribute('data-q'))" data-q="${item.q.replace(/"/g, '&quot;')}">${item.q}</button>`
      ).join('');
    }

    // Initialize on page load
    setTimeout(() => initSuggestionCategories(), 0);

    // ---- Follow-up Suggestions ----
    const FOLLOWUP_MAP = {
      'portfolio_summary': [
        'How has this performed over time?',
        'Am I too concentrated in any sector?',
        'What are my unrealized gains on these holdings?',
      ],
      'portfolio_performance': [
        'Show me my portfolio allocation breakdown',
        'How much have I invested in total?',
        'What dividends have I earned?',
      ],
      'transaction_history': [
        'What does my portfolio look like now?',
        'How has my portfolio performed since these trades?',
        'What are my unrealized gains?',
      ],
      'risk_assessment': [
        'Run a full health check on my portfolio',
        'What\'s my portfolio allocation?',
        'How has my portfolio performed this year?',
      ],
      'tax_estimate': [
        'Which positions have the biggest unrealized gains?',
        'What does my full portfolio look like?',
        'How has my portfolio performed?',
      ],
      'dividend_history': [
        'Show my investment timeline',
        'How has my portfolio performed this year?',
        'What does my portfolio allocation look like?',
      ],
      'portfolio_report': [
        'How diversified is my portfolio?',
        'What are my unrealized gains?',
        'Show me my performance this year',
      ],
      'investment_timeline': [
        'How has my portfolio performed?',
        'What dividends have I earned?',
        'What does my current portfolio look like?',
      ],
      'account_overview': [
        'What does my portfolio look like across all accounts?',
        'How has my portfolio performed?',
        'Show me my recent transactions',
      ],
      'market_data': [
        'What does my portfolio look like?',
        'How has my portfolio performed this year?',
        'Am I too heavy in any one stock?',
      ],
    };

    function showFollowups(toolCalls, aiFollowups) {
      const bar = document.getElementById('followups-bar');
      const list = document.getElementById('followups-list');
      if (!bar || !list) return;

      // Prefer AI-generated follow-ups, fall back to static map
      let followups = (aiFollowups && aiFollowups.length > 0) ? aiFollowups : [];

      if (followups.length === 0 && toolCalls && toolCalls.length > 0) {
        const seen = new Set();
        for (const tc of toolCalls) {
          const tool = tc.tool || tc;
          const suggestions = FOLLOWUP_MAP[tool] || [];
          for (const s of suggestions) {
            if (!seen.has(s)) { seen.add(s); followups.push(s); }
          }
        }
      }

      if (followups.length === 0) {
        bar.classList.remove('visible');
        return;
      }
      // Show max 3
      list.innerHTML = followups.slice(0, 3).map(s =>
        `<button class="followup-btn" onclick="sendSuggestion(this.textContent)">${s}</button>`
      ).join('');
      list.classList.remove('collapsed');
      document.getElementById('followups-arrow').classList.remove('collapsed');
      bar.classList.add('visible');
    }

    function toggleFollowups() {
      const list = document.getElementById('followups-list');
      const arrow = document.getElementById('followups-arrow');
      list.classList.toggle('collapsed');
      arrow.classList.toggle('collapsed');
    }

    // ---- Inline Chart Rendering ----
    let chartCounter = 0;
    const CHART_COLORS = [
      '#36cfb4', '#4ecdc4', '#45b7aa', '#2a9d8f', '#264653',
      '#e76f51', '#f4a261', '#e9c46a', '#8ab17d', '#7209b7',
      '#3a86ff', '#ff006e', '#fb5607', '#ffbe0b', '#8338ec',
    ];

    function renderCharts(container) {
      if (typeof Chart === 'undefined') return;
      // Find code blocks with language-chart class
      const codeBlocks = container.querySelectorAll('code.language-chart');
      codeBlocks.forEach(codeEl => {
        try {
          const config = JSON.parse(codeEl.textContent);
          const preEl = codeEl.closest('pre');
          if (!preEl) return;

          const chartId = `chart-${++chartCounter}`;
          const wrapper = document.createElement('div');
          wrapper.className = 'chart-container';
          if (config.title) {
            const titleEl = document.createElement('div');
            titleEl.className = 'chart-title';
            titleEl.textContent = config.title;
            wrapper.appendChild(titleEl);
          }
          const canvas = document.createElement('canvas');
          canvas.id = chartId;
          wrapper.appendChild(canvas);
          preEl.replaceWith(wrapper);

          const type = config.type || 'bar';
          const labels = config.labels || [];
          const data = config.data || [];
          const colors = labels.map((_, i) => CHART_COLORS[i % CHART_COLORS.length]);

          const chartConfig = {
            type: type,
            data: {
              labels: labels,
              datasets: [{
                data: data,
                backgroundColor: type === 'line' ? 'rgba(54, 207, 180, 0.1)' : colors,
                borderColor: type === 'line' ? '#36cfb4' : colors.map(c => c),
                borderWidth: type === 'line' ? 2 : 1,
                fill: type === 'line',
                tension: 0.3,
                pointRadius: type === 'line' ? 3 : undefined,
                pointBackgroundColor: type === 'line' ? '#36cfb4' : undefined,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: type === 'pie' || type === 'doughnut',
                  position: 'right',
                  labels: { color: '#aaa', font: { size: 11 }, padding: 8 }
                },
                tooltip: {
                  callbacks: {
                    label: function(ctx) {
                      const val = ctx.parsed !== undefined ? (ctx.parsed.y !== undefined ? ctx.parsed.y : ctx.parsed) : ctx.raw;
                      const suffix = config.suffix || (config.currency ? ` ${config.currency}` : '');
                      return `${ctx.label}: ${typeof val === 'number' ? val.toLocaleString() : val}${suffix}`;
                    }
                  }
                }
              },
              scales: (type === 'pie' || type === 'doughnut') ? {} : {
                x: { ticks: { color: '#888', font: { size: 10 } }, grid: { color: '#1a1a1a' } },
                y: { ticks: { color: '#888', font: { size: 10 } }, grid: { color: '#1a1a1a' } }
              }
            }
          };

          // Handle multiple datasets for line charts
          if (config.datasets) {
            chartConfig.data.datasets = config.datasets.map((ds, i) => ({
              label: ds.label || `Series ${i+1}`,
              data: ds.data || [],
              backgroundColor: 'rgba(54, 207, 180, 0.1)',
              borderColor: CHART_COLORS[i % CHART_COLORS.length],
              borderWidth: 2,
              fill: false,
              tension: 0.3,
              pointRadius: 3,
            }));
          }

          new Chart(canvas, chartConfig);
        } catch (e) {
          console.warn('Chart render failed:', e);
        }
      });
    }

    function typewriterEffect(element, duration) {
      duration = duration || 1200;
      const textNodes = [];
      const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
      while (walker.nextNode()) textNodes.push(walker.currentNode);
      if (textNodes.length === 0) return;

      const originals = textNodes.map(n => n.textContent);
      textNodes.forEach(n => n.textContent = '');

      const totalChars = originals.reduce((sum, t) => sum + t.length, 0);
      if (totalChars === 0) return;

      const msPerChar = Math.min(duration / totalChars, 8);
      let nodeIdx = 0;
      let nodeCharIdx = 0;

      function step() {
        if (nodeIdx >= textNodes.length) {
          chat.scrollTop = chat.scrollHeight;
          return;
        }
        // Reveal multiple chars per frame for speed
        const charsPerFrame = Math.max(1, Math.floor(2 / msPerChar));
        for (let i = 0; i < charsPerFrame && nodeIdx < textNodes.length; i++) {
          const orig = originals[nodeIdx];
          nodeCharIdx++;
          textNodes[nodeIdx].textContent = orig.substring(0, nodeCharIdx);
          if (nodeCharIdx >= orig.length) {
            nodeIdx++;
            nodeCharIdx = 0;
          }
        }
        if (nodeIdx < textNodes.length) {
          setTimeout(step, msPerChar * charsPerFrame);
        } else {
          chat.scrollTop = chat.scrollHeight;
        }
      }
      step();
    }

    function addMessage(text, role, toolCalls, verification, useTypewriter) {
      const div = document.createElement('div');
      div.className = `message ${role}`;

      if (role === 'assistant') {
        const contentDiv = document.createElement('div');
        contentDiv.className = 'msg-content';
        contentDiv.setAttribute('data-raw', text);
        if (settings.markdown && typeof marked !== 'undefined') {
          contentDiv.innerHTML = marked.parse(text);
          renderCharts(contentDiv);
        } else {
          contentDiv.textContent = text;
          contentDiv.classList.add('raw');
        }
        div.appendChild(contentDiv);

        if (toolCalls?.length) {
          const tc = document.createElement('div');
          tc.className = 'tool-calls';
          const uniqueTools = [...new Set(toolCalls.map(t => t.tool))];
          tc.innerHTML = 'Tools used: ' + uniqueTools.map(t => `<span>${t}</span>`).join('');
          div.appendChild(tc);
        }

        if (verification && (verification.checks?.length > 0 || verification.confidence)) {
          const vDiv = document.createElement('div');
          vDiv.className = `verification ${verification.verified ? 'pass' : 'fail'}`;
          const icon = verification.verified ? '&#10003;' : '&#9888;';
          let html = `${icon} Verified: ${(verification.checks || []).map(c => `${c.passed ? '&#10003;' : '&#10007;'} ${c.check}`).join(', ')}`;
          if (verification.confidence) {
            const conf = verification.confidence.overall;
            const color = conf >= 80 ? '#36cfb4' : conf >= 50 ? '#f0c674' : '#f87171';
            html += ` &nbsp;|&nbsp; <span style="color:${color}">Confidence: ${conf}%</span>`;
          }
          vDiv.innerHTML = html;
          div.appendChild(vDiv);
        }

        const fb = document.createElement('div');
        fb.className = 'msg-feedback';
        const msgIdx = chat.querySelectorAll('.message.assistant').length;
        fb.innerHTML = `
          <div class="fb-row">
            <button class="fb-btn" onclick="feedback(this, ${msgIdx}, 'up')" title="Helpful">&#128077;</button>
            <button class="fb-btn" onclick="feedback(this, ${msgIdx}, 'down')" title="Not helpful">&#128078;</button>
          </div>
          <div class="fb-prompt">Are you happy with my response?</div>
          <div class="fb-explain" id="fb-explain-${msgIdx}">
            <input type="text" placeholder="Optional explanation..." onkeydown="if(event.key==='Enter')submitFeedback(${msgIdx})" />
            <button class="fb-submit" onclick="submitFeedback(${msgIdx})">Submit</button>
          </div>
          <div class="fb-recorded" id="fb-recorded-${msgIdx}">Your response has been recorded.</div>
        `;
        div.appendChild(fb);
      } else {
        div.textContent = text;
      }

      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;

      // Typewriter effect for new assistant messages
      if (useTypewriter && role === 'assistant') {
        const contentDiv = div.querySelector('.msg-content');
        if (contentDiv) typewriterEffect(contentDiv, 1200);
      }
    }

    let pendingFeedback = {};

    function feedback(btn, msgIdx, direction) {
      const fbContainer = btn.closest('.msg-feedback');
      fbContainer.querySelectorAll('.fb-btn').forEach(b => { b.classList.remove('liked', 'disliked'); });
      const prompt = fbContainer.querySelector('.fb-prompt');
      pendingFeedback[msgIdx] = direction;
      if (direction === 'up') {
        btn.classList.add('liked');
        if (prompt) prompt.textContent = 'Thank you for your feedback!';
        const explainEl = document.getElementById(`fb-explain-${msgIdx}`);
        if (explainEl) explainEl.classList.remove('visible');
        sendFeedback(msgIdx, direction, '');
        // Dismiss feedback section after a moment
        setTimeout(() => {
          fbContainer.classList.add('fb-done');
          const recordedEl = document.getElementById(`fb-recorded-${msgIdx}`);
          if (recordedEl) { recordedEl.textContent = 'Feedback received \u2014 thank you!'; recordedEl.classList.add('visible'); }
        }, 1200);
      } else {
        btn.classList.add('disliked');
        if (prompt) prompt.textContent = 'Help us improve \u2014 what went wrong?';
        const explainEl = document.getElementById(`fb-explain-${msgIdx}`);
        if (explainEl) {
          explainEl.classList.add('visible');
          explainEl.querySelector('input').focus();
        }
      }
    }

    function submitFeedback(msgIdx) {
      const explainEl = document.getElementById(`fb-explain-${msgIdx}`);
      const explanation = explainEl ? explainEl.querySelector('input').value : '';
      sendFeedback(msgIdx, pendingFeedback[msgIdx] || 'down', explanation);
      // Find the parent feedback container and dismiss it
      const fbContainer = explainEl ? explainEl.closest('.msg-feedback') : null;
      if (fbContainer) {
        fbContainer.classList.add('fb-done');
        const recordedEl = document.getElementById(`fb-recorded-${msgIdx}`);
        if (recordedEl) {
          recordedEl.textContent = 'Feedback received \u2014 thank you!';
          recordedEl.classList.add('visible');
        }
      }
    }

    function sendFeedback(msgIdx, direction, explanation) {
      const msgs = document.querySelectorAll('.message.assistant');
      const msgContent = msgs[msgIdx]?.querySelector('.msg-content')?.textContent?.substring(0, 200) || '';
      fetch('/api/v1/agent/feedback', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` },
        body: JSON.stringify({
          conversationId: currentConversationId,
          messageIndex: msgIdx,
          direction: direction,
          explanation: explanation || null,
          messageContent: msgContent,
        })
      }).catch(err => console.warn('Feedback send failed:', err));
    }

    // Admin Panel
    function toggleAdminPanel() {
      const overlay = document.getElementById('admin-overlay');
      overlay.classList.toggle('visible');
      if (overlay.classList.contains('visible')) {
        loadAdminStats();
        loadSdkSettings();
      }
    }

    function switchAdminTab(tab) {
      document.querySelectorAll('#admin-overlay .admin-tab').forEach(el => {
        el.classList.toggle('active', el.getAttribute('data-tab') === tab);
      });
      document.querySelectorAll('[id^="admin-tab-"]').forEach(el => {
        el.style.display = el.id === `admin-tab-${tab}` ? 'block' : 'none';
      });
    }

    // ---- User Settings overlay ----
    function toggleSettings() {
      const overlay = document.getElementById('settings-overlay');
      overlay.classList.toggle('visible');
      if (overlay.classList.contains('visible')) {
        applySettings();
        loadSettingsProfile();
        loadSettingsBackends();
      }
    }

    function switchSettingsTab(tab) {
      document.querySelectorAll('#settings-overlay .admin-tab').forEach(el => {
        el.classList.toggle('active', el.getAttribute('data-stab') === tab);
      });
      document.querySelectorAll('[id^="settings-tab-"]').forEach(el => {
        el.style.display = el.id === `settings-tab-${tab}` ? 'block' : 'none';
      });
    }

    async function loadSettingsProfile() {
      try {
        const res = await fetch(`${API_BASE}/profile`, { headers: { 'Authorization': `Bearer ${TOKEN}` } });
        if (!res.ok) return;
        const data = await res.json();
        document.getElementById('settings-user-id').textContent = data.userId || '--';
        document.getElementById('settings-username').value = data.username || '';
      } catch {}
    }

    async function saveSettingsUsername() {
      const name = document.getElementById('settings-username').value.trim();
      if (!name) return;
      try {
        const res = await fetch(`${API_BASE}/profile/username`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${TOKEN}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: name })
        });
        if (res.ok) {
          _profileUsername = name;
          const saved = document.getElementById('settings-name-saved');
          saved.style.display = 'block';
          setTimeout(() => saved.style.display = 'none', 3000);
          // Update badge and dropdown
          document.getElementById('badge-text').textContent = name;
          document.getElementById('pd-name').textContent = name;
        }
      } catch {}
    }

    async function loadSettingsBackends() {
      const container = document.getElementById('settings-backends-list');
      try {
        const res = await fetch(`${API_BASE}/backends`, { headers: { 'Authorization': `Bearer ${TOKEN}` } });
        if (!res.ok) { container.innerHTML = '<div style="color:#f87171; padding:12px;">Failed to load backends.</div>'; return; }
        const data = await res.json();
        const backends = data.backends || [];
        if (backends.length === 0) {
          container.innerHTML = '<div class="admin-card" style="text-align:center; color:#888; padding:24px;">No backends connected. Click "+ Add Backend" to get started.</div>';
          return;
        }
        container.innerHTML = backends.map(b => `
          <div class="admin-card" style="margin-bottom:8px; display:flex; align-items:center; gap:12px;">
            <div style="flex:1;">
              <div style="display:flex; align-items:center; gap:8px;">
                <span style="background:${b.is_active?'#36cfb4':'#555'}; color:#000; font-size:10px; font-weight:700; padding:2px 8px; border-radius:10px; text-transform:uppercase;">${b.provider}</span>
                <span style="color:#e5e5e5; font-size:13px; font-weight:500;">${b.label || 'Untitled'}</span>
              </div>
              <div style="color:#666; font-size:11px; margin-top:4px;">${b.base_url}</div>
            </div>
            <div style="display:flex; align-items:center; gap:6px;">
              <div class="pd-be-toggle ${b.is_active?'active':'inactive'}" onclick="toggleBackend('${b.id}', ${!b.is_active})" title="${b.is_active?'Disable':'Enable'}"></div>
              <button onclick="testBackend('${b.id}')" style="padding:4px 10px; background:#1a1a1a; border:1px solid #333; color:#888; border-radius:5px; font-size:11px; cursor:pointer;" title="Test connection">Test</button>
              <button onclick="deleteBackend('${b.id}')" style="padding:4px 8px; background:#1a1a1a; border:1px solid #333; color:#f87171; border-radius:5px; font-size:11px; cursor:pointer;" title="Remove">&times;</button>
            </div>
          </div>
        `).join('');
      } catch {
        container.innerHTML = '<div style="color:#f87171; padding:12px;">Failed to load backends.</div>';
      }
    }

    function loadAdminStats() {
      const totalConvos = allConversations.length;
      const totalMsgs = allConversations.reduce((sum, c) => sum + (c._count?.messages || 0), 0);
      document.getElementById('stat-total-convos').textContent = totalConvos;
      document.getElementById('stat-total-messages').textContent = totalMsgs;
      const catCounts = {};
      allConversations.forEach(c => {
        const cat = classifyConversation(c.title);
        catCounts[cat] = (catCounts[cat] || 0) + 1;
      });
      const catDist = document.getElementById('admin-category-dist');
      if (Object.keys(catCounts).length > 0) {
        catDist.innerHTML = Object.entries(catCounts)
          .sort((a, b) => b[1] - a[1])
          .map(([cat, count]) =>
            `<div class="admin-list-item">
              <span class="label" style="text-transform:capitalize">${cat}</span>
              <span class="value">${count} conversation${count !== 1 ? 's' : ''}</span>
            </div>`
          ).join('');
      }
    }

    // SDK / Provider Settings
    let sdkSettings = {};

    async function loadSdkSettings() {
      try {
        const res = await fetch(`${API_BASE}/admin/settings`);
        if (!res.ok) return;
        sdkSettings = await res.json();

        // Populate SDK dropdown
        const sdkSelect = document.getElementById('admin-sdk-select');
        sdkSelect.innerHTML = '';
        for (const opt of (sdkSettings.sdkOptions || [])) {
          const option = document.createElement('option');
          option.value = opt.id;
          option.textContent = opt.name;
          if (opt.id === sdkSettings.sdk) option.selected = true;
          sdkSelect.appendChild(option);
        }
        onSdkChange();

        // Populate model dropdown
        const modelSelect = document.getElementById('admin-model-select');
        modelSelect.innerHTML = '';
        for (const opt of (sdkSettings.modelOptions || [])) {
          const option = document.createElement('option');
          option.value = opt.id;
          option.textContent = `${opt.name} (${opt.provider})`;
          if (opt.id === sdkSettings.model) option.selected = true;
          modelSelect.appendChild(option);
        }
        onModelChange();

        // Update key status
        document.getElementById('openai-key-status').textContent = sdkSettings.hasOpenaiKey ? '(configured)' : '(not set)';
        document.getElementById('openai-key-status').style.color = sdkSettings.hasOpenaiKey ? '#36cfb4' : '#f87171';
        document.getElementById('anthropic-key-status').textContent = sdkSettings.hasAnthropicKey ? '(configured)' : '(not set)';
        document.getElementById('anthropic-key-status').style.color = sdkSettings.hasAnthropicKey ? '#36cfb4' : '#f87171';
        document.getElementById('openrouter-key-status').textContent = sdkSettings.hasOpenrouterKey ? '(configured)' : '(not set)';
        document.getElementById('openrouter-key-status').style.color = sdkSettings.hasOpenrouterKey ? '#36cfb4' : '#f87171';

        // Update header badge
        updateSdkBadge(sdkSettings.sdk);
      } catch (e) {
        console.log('Failed to load SDK settings:', e);
      }
    }

    function onSdkChange() {
      const sdkId = document.getElementById('admin-sdk-select').value;
      const opt = (sdkSettings.sdkOptions || []).find(o => o.id === sdkId);
      document.getElementById('sdk-desc').textContent = opt ? opt.description : '';
    }

    function onModelChange() {
      const modelId = document.getElementById('admin-model-select').value;
      const opt = (sdkSettings.modelOptions || []).find(o => o.id === modelId);
      document.getElementById('model-desc').textContent = opt && opt.description ? opt.description : '';
    }

    function updateSdkBadge(sdkId) {
      const badge = document.getElementById('sdk-badge');
      if (!badge) return;
      const opt = (sdkSettings.sdkOptions || []).find(o => o.id === sdkId);
      badge.textContent = opt ? opt.name : sdkId;
    }

    async function saveAdminSettings() {
      const btn = document.getElementById('admin-save-btn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      const body = {
        sdk: document.getElementById('admin-sdk-select').value,
        model: document.getElementById('admin-model-select').value,
      };

      const openaiKey = document.getElementById('admin-openai-key').value;
      if (openaiKey) body.openai_api_key = openaiKey;

      const anthropicKey = document.getElementById('admin-anthropic-key').value;
      if (anthropicKey) body.anthropic_api_key = anthropicKey;

      const openrouterKey = document.getElementById('admin-openrouter-key').value;
      if (openrouterKey) body.openrouter_api_key = openrouterKey;

      try {
        const res = await fetch(`${API_BASE}/admin/settings`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        if (res.ok) {
          const msg = document.getElementById('settings-saved-msg');
          msg.classList.add('visible');
          setTimeout(() => msg.classList.remove('visible'), 3000);
          updateSdkBadge(body.sdk);
          // Clear key inputs
          document.getElementById('admin-openai-key').value = '';
          document.getElementById('admin-anthropic-key').value = '';
          document.getElementById('admin-openrouter-key').value = '';
          // Reload to update status
          await loadSdkSettings();
        }
      } catch (e) {
        alert('Failed to save settings: ' + e.message);
      }

      btn.disabled = false;
      btn.textContent = 'Save Settings';
    }

    // ---- Eval Runner ----

    async function runEvals() {
      const btn = document.getElementById('eval-run-btn');
      const checkBtn = document.getElementById('eval-check-btn');
      btn.disabled = true;
      checkBtn.disabled = true;
      btn.textContent = 'Running...';

      const progressEl = document.getElementById('eval-progress');
      const resultsEl = document.getElementById('eval-results');
      const logEl = document.getElementById('eval-progress-log');
      const barEl = document.getElementById('eval-progress-bar');
      const phaseTitle = document.getElementById('eval-phase-title');
      const phaseDesc = document.getElementById('eval-phase-desc');

      progressEl.style.display = 'block';
      resultsEl.style.display = 'none';
      logEl.innerHTML = '';
      barEl.style.width = '0%';

      const evalStartTime = Date.now();

      // Phase 1: Generate Snapshots
      phaseTitle.textContent = 'Step 1: Generating Snapshots';
      phaseDesc.textContent = 'Sending test cases to the live agent. This makes real LLM calls and costs tokens...';
      logEl.innerHTML += '<div style="color:#36cfb4;">Starting snapshot generation...</div>';

      try {
        const snapRes = await fetch(`${API_BASE}/admin/eval/snapshot`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${TOKEN}` },
        });

        if (!snapRes.ok) {
          throw new Error(`Snapshot generation failed: HTTP ${snapRes.status}`);
        }

        const snapData = await snapRes.json();
        barEl.style.width = '50%';

        // Log snapshot results
        for (const snap of (snapData.snapshots || [])) {
          const tools = snap.toolCalls.length > 0 ? snap.toolCalls.join(', ') : 'none';
          logEl.innerHTML += `<div><span style="color:#36cfb4;">[${snap.id}]</span> ${snap.query.substring(0, 40)}... <span style="color:#666;">(${snap.durationMs}ms, tools: ${tools})</span></div>`;
        }
        for (const err of (snapData.errors || [])) {
          logEl.innerHTML += `<div style="color:#ff4444;">[${err.id}] ERROR: ${err.error}</div>`;
        }

        logEl.innerHTML += `<div style="color:#36cfb4; margin-top:4px;">Snapshots captured: ${snapData.captured}/${snapData.total}</div>`;

        // Phase 2: Run Checks
        phaseTitle.textContent = 'Step 2: Running Deterministic Checks';
        phaseDesc.textContent = 'Validating responses against golden data rules. No LLM calls  pure string matching...';
        logEl.innerHTML += '<div style="color:#36cfb4; margin-top:8px;">Running deterministic checks...</div>';

        const checkRes = await fetch(`${API_BASE}/admin/eval/check`, {
          method: 'POST',
        });

        if (!checkRes.ok) {
          throw new Error(`Check failed: HTTP ${checkRes.status}`);
        }

        const checkData = await checkRes.json();
        barEl.style.width = '100%';

        // Log check results
        for (const r of (checkData.results || [])) {
          const icon = r.passed ? '<span style="color:#4CAF50;">PASS</span>' : '<span style="color:#ff4444;">FAIL</span>';
          logEl.innerHTML += `<div><span style="color:#36cfb4;">[${r.id}]</span> ${icon} ${r.query.substring(0, 45)}</div>`;
          if (!r.passed) {
            for (const c of r.checks) {
              if (!c.passed) {
                logEl.innerHTML += `<div style="padding-left:20px; color:#ff4444;">  x [${c.type}] ${c.detail}</div>`;
              }
            }
          }
        }

        logEl.scrollTop = logEl.scrollHeight;

        // Show results summary
        const evalDuration = ((Date.now() - evalStartTime) / 1000).toFixed(1);
        phaseTitle.textContent = 'Eval Complete';
        phaseDesc.textContent = `Total time: ${evalDuration}s`;
        displayEvalResults(snapData, checkData, evalDuration);

      } catch (err) {
        logEl.innerHTML += `<div style="color:#ff4444;">Error: ${err.message}</div>`;
        phaseTitle.textContent = 'Eval Failed';
        phaseDesc.textContent = err.message;
      }

      btn.disabled = false;
      checkBtn.disabled = false;
      btn.textContent = 'Run Full Eval';
    }

    async function runCheckOnly() {
      const btn = document.getElementById('eval-check-btn');
      btn.disabled = true;
      btn.textContent = 'Checking...';

      const progressEl = document.getElementById('eval-progress');
      const logEl = document.getElementById('eval-progress-log');
      const barEl = document.getElementById('eval-progress-bar');
      const phaseTitle = document.getElementById('eval-phase-title');
      const phaseDesc = document.getElementById('eval-phase-desc');

      progressEl.style.display = 'block';
      logEl.innerHTML = '';
      barEl.style.width = '50%';

      phaseTitle.textContent = 'Running Deterministic Checks';
      phaseDesc.textContent = 'Validating existing snapshots against golden data. No LLM calls...';

      try {
        const checkRes = await fetch(`${API_BASE}/admin/eval/check`, {
          method: 'POST',
        });

        if (!checkRes.ok) {
          const data = await checkRes.json().catch(() => ({}));
          throw new Error(data.error || `HTTP ${checkRes.status}`);
        }

        const checkData = await checkRes.json();
        barEl.style.width = '100%';

        if (checkData.error) {
          logEl.innerHTML += `<div style="color:#ff4444;">${checkData.error}</div>`;
        } else {
          for (const r of (checkData.results || [])) {
            const icon = r.passed ? '<span style="color:#4CAF50;">PASS</span>' : '<span style="color:#ff4444;">FAIL</span>';
            logEl.innerHTML += `<div><span style="color:#36cfb4;">[${r.id}]</span> ${icon} ${r.query.substring(0, 45)}</div>`;
            if (!r.passed) {
              for (const c of r.checks) {
                if (!c.passed) {
                  logEl.innerHTML += `<div style="padding-left:20px; color:#ff4444;">  x [${c.type}] ${c.detail}</div>`;
                }
              }
            }
          }

          phaseTitle.textContent = 'Check Complete';
          phaseDesc.textContent = `Snapshots from: ${checkData.generatedAt || 'unknown'}`;
          displayEvalResults(null, checkData);
        }
      } catch (err) {
        logEl.innerHTML += `<div style="color:#ff4444;">Error: ${err.message}</div>`;
      }

      btn.disabled = false;
      btn.textContent = 'Re-run Checks Only';
    }

    function displayEvalResults(snapData, checkData, evalDuration) {
      const resultsEl = document.getElementById('eval-results');
      resultsEl.style.display = 'block';

      document.getElementById('eval-snap-time').textContent = checkData.generatedAt || (snapData ? 'Just now' : '--');
      document.getElementById('eval-total-time').textContent = evalDuration ? `${evalDuration}s` : '--';
      document.getElementById('eval-cases-pass').textContent = `${checkData.cases.passed}/${checkData.cases.total}`;
      document.getElementById('eval-checks-pass').textContent = `${checkData.checks.passed}/${checkData.checks.total}`;

      const passRate = checkData.cases.total > 0 ? (checkData.cases.passed / checkData.cases.total * 100).toFixed(0) : 0;
      const casesEl = document.getElementById('eval-cases-pass');
      casesEl.style.color = passRate == 100 ? '#4CAF50' : passRate >= 80 ? '#FFC107' : '#ff4444';

      // Build results table
      const tableEl = document.getElementById('eval-results-table');
      let html = '<table style="width:100%; font-size:12px; border-collapse:collapse;">';
      html += '<tr style="color:#999; text-align:left; border-bottom:1px solid #333;"><th style="padding:6px;">ID</th><th style="padding:6px;">Query</th><th style="padding:6px;">Category</th><th style="padding:6px;">Result</th></tr>';

      for (const r of (checkData.results || [])) {
        const color = r.passed ? '#4CAF50' : '#ff4444';
        const icon = r.passed ? 'PASS' : 'FAIL';
        html += `<tr style="border-bottom:1px solid #1a1a1a;">`;
        html += `<td style="padding:6px; color:#666;">${r.id}</td>`;
        html += `<td style="padding:6px; color:#ccc;" title="${r.query}">${r.query.substring(0, 40)}${r.query.length > 40 ? '...' : ''}</td>`;
        html += `<td style="padding:6px; color:#888;">${r.category}</td>`;
        html += `<td style="padding:6px; color:${color}; font-weight:600;">${icon}</td>`;
        html += `</tr>`;

        if (!r.passed) {
          for (const c of r.checks) {
            if (!c.passed) {
              html += `<tr><td></td><td colspan="3" style="padding:2px 6px 6px 16px; color:#ff4444; font-size:11px;">x [${c.type}] ${c.detail}</td></tr>`;
            }
          }
        }
      }

      html += '</table>';
      tableEl.innerHTML = html;
    }

    // ---- Eval Tab Combined Loader ----
    let evalsTabLoaded = false;
    async function loadEvalsTab() {
      if (evalsTabLoaded) return;
      evalsTabLoaded = true;
      loadEvalHistory();
      loadFeedbackDetail();
    }

    function toggleEvalHistory() {
      const content = document.getElementById('eval-history-content');
      const arrow = document.getElementById('eval-history-arrow');
      if (content.style.display === 'none') {
        content.style.display = 'block';
        arrow.innerHTML = '&#9660;';
      } else {
        content.style.display = 'none';
        arrow.innerHTML = '&#9654;';
      }
    }

    // ---- Eval History (auto-loaded, expandable) ----
    async function loadEvalHistory() {
      const container = document.getElementById('eval-history-content');
      container.style.display = 'block';
      document.getElementById('eval-history-arrow').innerHTML = '&#9660;';
      container.innerHTML = '<div style="color:#888; font-size:12px;">Loading...</div>';
      try {
        const res = await fetch(`${API_BASE}/admin/eval/history`);
        const data = await res.json();
        const runs = data.runs || [];
        if (runs.length === 0) {
          container.innerHTML = '<div class="admin-placeholder">No eval runs recorded yet. Run an eval to see history.</div>';
          return;
        }
        let html = '<table style="width:100%; font-size:12px; border-collapse:collapse;">';
        html += '<tr style="color:#888; text-align:left; border-bottom:1px solid #333;"><th style="padding:6px;">Date</th><th style="padding:6px;">Model</th><th style="padding:6px;">Cases</th><th style="padding:6px;">Checks</th><th style="padding:6px;">Rate</th></tr>';
        for (const r of runs) {
          const date = new Date(r.createdAt).toLocaleString('en-US', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
          const rate = r.casesTotal > 0 ? (r.casesPassed / r.casesTotal * 100).toFixed(0) : 0;
          const color = rate == 100 ? '#4CAF50' : rate >= 80 ? '#FFC107' : '#ff4444';
          html += `<tr style="border-bottom:1px solid #1a1a1a; cursor:pointer;" onclick="toggleEvalRunDetail('${r.id}', this)">`;
          html += `<td style="padding:6px; color:#999;">${date}</td>`;
          html += `<td style="padding:6px; color:#ccc;">${r.model || '--'}</td>`;
          html += `<td style="padding:6px; color:#e0e0e0;">${r.casesPassed}/${r.casesTotal}</td>`;
          html += `<td style="padding:6px; color:#e0e0e0;">${r.checksPassed}/${r.checksTotal}</td>`;
          html += `<td style="padding:6px; color:${color}; font-weight:600;">${rate}%</td>`;
          html += `</tr>`;
          html += `<tr id="eval-detail-${r.id}" style="display:none;"><td colspan="5" style="padding:0;"></td></tr>`;
        }
        html += '</table>';
        container.innerHTML = html;
      } catch (err) {
        container.innerHTML = `<div style="color:#ff4444; font-size:12px;">Error: ${err.message}</div>`;
      }
    }

    async function toggleEvalRunDetail(runId, rowEl) {
      const detailRow = document.getElementById(`eval-detail-${runId}`);
      if (!detailRow) return;
      if (detailRow.style.display !== 'none') {
        detailRow.style.display = 'none';
        return;
      }
      const cell = detailRow.querySelector('td');
      cell.innerHTML = '<div style="padding:8px; color:#888; font-size:11px;">Loading results...</div>';
      detailRow.style.display = 'table-row';
      try {
        const res = await fetch(`${API_BASE}/admin/eval/history/${runId}`);
        const data = await res.json();
        const results = data.results || [];
        if (results.length === 0) {
          cell.innerHTML = '<div style="padding:8px; color:#666; font-size:11px;">No detailed results stored for this run.</div>';
          return;
        }
        let html = '<div style="padding:8px 16px; background:#111; border-radius:4px; margin:4px 0;">';
        html += '<table style="width:100%; font-size:11px; border-collapse:collapse;">';
        html += '<tr style="color:#666;"><th style="padding:4px; text-align:left;">ID</th><th style="padding:4px; text-align:left;">Query</th><th style="padding:4px;">Category</th><th style="padding:4px;">Result</th></tr>';
        for (const r of results) {
          const passColor = r.passed ? '#4CAF50' : '#ff4444';
          const passText = r.passed ? 'PASS' : 'FAIL';
          html += `<tr style="border-bottom:1px solid #1a1a1a;"><td style="padding:4px; color:#666;">${r.id}</td><td style="padding:4px; color:#999;" title="${r.query || ''}">${(r.query || '').substring(0, 50)}</td><td style="padding:4px; color:#888; text-align:center;">${r.category || ''}</td><td style="padding:4px; color:${passColor}; font-weight:600; text-align:center;">${passText}</td></tr>`;
          if (!r.passed && r.checks) {
            for (const c of r.checks.filter(ch => !ch.passed)) {
              html += `<tr><td></td><td colspan="3" style="padding:2px 4px; color:#f87171; font-size:10px;">[${c.type}] ${c.detail}</td></tr>`;
            }
          }
        }
        html += '</table></div>';
        cell.innerHTML = html;
      } catch (err) {
        cell.innerHTML = `<div style="padding:8px; color:#ff4444; font-size:11px;">Error: ${err.message}</div>`;
      }
    }

    // ---- Agent Feedback Detail (embedded in evals tab) ----
    async function loadFeedbackDetail() {
      const loading = document.getElementById('fbd-loading');
      const content = document.getElementById('fbd-content');
      loading.style.display = 'block';
      content.style.display = 'none';

      try {
        const res = await fetch(`${API_BASE}/feedback/detail`, {
          headers: { 'Authorization': `Bearer ${TOKEN}` }
        });
        const data = await res.json();

        // KPI cards
        document.getElementById('fbd-total').textContent = data.total || 0;
        document.getElementById('fbd-up').textContent = data.thumbsUp || 0;
        document.getElementById('fbd-down').textContent = data.thumbsDown || 0;
        document.getElementById('fbd-rate').textContent = data.satisfactionRate || '--';

        // Per-conversation table
        const convTable = document.getElementById('fbd-conv-table');
        const perConv = data.perConversation || [];
        if (perConv.length > 0) {
          let html = '<table style="width:100%; font-size:12px; border-collapse:collapse;">';
          html += '<tr style="color:#888; text-align:left; border-bottom:1px solid #333;"><th style="padding:6px;">Conversation</th><th style="padding:6px; text-align:center;">&#128077;</th><th style="padding:6px; text-align:center;">&#128078;</th><th style="padding:6px; text-align:center;">Total</th></tr>';
          for (const c of perConv) {
            const title = (c.title || 'Unknown').substring(0, 40) + (c.title && c.title.length > 40 ? '...' : '');
            html += `<tr style="border-bottom:1px solid #1a1a1a;"><td style="padding:6px; color:#ccc;" title="${c.title || ''}">${title}</td><td style="padding:6px; text-align:center; color:#4CAF50; font-weight:600;">${c.ups}</td><td style="padding:6px; text-align:center; color:#f87171; font-weight:600;">${c.downs}</td><td style="padding:6px; text-align:center; color:#e0e0e0;">${c.total}</td></tr>`;
          }
          html += '</table>';
          convTable.innerHTML = html;
        } else {
          convTable.innerHTML = '<div class="admin-placeholder">No per-conversation feedback yet</div>';
        }

        // Negative feedback details
        const negTable = document.getElementById('fbd-negative-table');
        const entries = data.entries || [];
        const negEntries = entries.filter(e => e.direction === 'down');
        if (negEntries.length > 0) {
          let html = '<table style="width:100%; font-size:12px; border-collapse:collapse;">';
          html += '<tr style="color:#888; text-align:left; border-bottom:1px solid #333;"><th style="padding:6px;">Time</th><th style="padding:6px;">Conversation</th><th style="padding:6px;">Reason</th></tr>';
          for (const e of negEntries) {
            const time = e.timestamp ? new Date(e.timestamp).toLocaleString('en-US', {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '--';
            const convTitle = (e.convTitle || '--').substring(0, 30);
            const reason = e.explanation ? `<span style="color:#ccc;">${e.explanation}</span>` : '<span style="color:#555; font-style:italic;">No reason given</span>';
            html += `<tr style="border-bottom:1px solid #1a1a1a;"><td style="padding:6px; color:#888; white-space:nowrap;">${time}</td><td style="padding:6px; color:#999;">${convTitle}</td><td style="padding:6px;">${reason}</td></tr>`;
          }
          html += '</table>';
          negTable.innerHTML = html;
        } else {
          negTable.innerHTML = '<div class="admin-placeholder">No negative feedback yet</div>';
        }

        // All recent entries
        const allTable = document.getElementById('fbd-all-table');
        if (entries.length > 0) {
          let html = '<table style="width:100%; font-size:11px; border-collapse:collapse;">';
          html += '<tr style="color:#888; text-align:left; border-bottom:1px solid #333;"><th style="padding:5px;">Time</th><th style="padding:5px;">Vote</th><th style="padding:5px;">Conversation</th><th style="padding:5px;">Note</th></tr>';
          for (const e of entries.slice(0, 30)) {
            const time = e.timestamp ? new Date(e.timestamp).toLocaleString('en-US', {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '--';
            const vote = e.direction === 'up' ? '<span style="color:#4CAF50;">&#128077;</span>' : '<span style="color:#f87171;">&#128078;</span>';
            const convTitle = (e.convTitle || '--').substring(0, 25);
            const note = e.explanation || '<span style="color:#444;">--</span>';
            html += `<tr style="border-bottom:1px solid #1a1a1a;"><td style="padding:5px; color:#888; white-space:nowrap;">${time}</td><td style="padding:5px;">${vote}</td><td style="padding:5px; color:#999;">${convTitle}</td><td style="padding:5px; color:#ccc;">${note}</td></tr>`;
          }
          html += '</table>';
          allTable.innerHTML = html;
        } else {
          allTable.innerHTML = '<div class="admin-placeholder">No feedback entries yet</div>';
        }

        loading.style.display = 'none';
        content.style.display = 'block';
      } catch (err) {
        loading.style.display = 'none';
        document.getElementById('fbd-content').style.display = 'block';
        document.getElementById('fbd-all-table').innerHTML = `<p style="color:#f87171;">Error loading feedback: ${err.message}</p>`;
      }
    }

    // ---- Portfolio Import ----
    (function initPortfolioImport() {
      const dropZone = document.getElementById('portfolio-drop-zone');
      const fileInput = document.getElementById('portfolio-file-input');
      if (!dropZone || !fileInput) return;

      dropZone.addEventListener('click', () => fileInput.click());
      dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        if (e.dataTransfer.files.length > 0) handlePortfolioFile(e.dataTransfer.files[0]);
      });
      fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) handlePortfolioFile(fileInput.files[0]);
      });
    })();

    let portfolioFile = null;
    let portfolioParsedOrders = [];
    let portfolioFileHash = '';

    function handlePortfolioFile(file) {
      const validExts = ['.csv', '.json'];
      const ext = '.' + file.name.split('.').pop().toLowerCase();
      if (!validExts.includes(ext)) {
        alert('Unsupported file type. Please use CSV or JSON.');
        return;
      }
      portfolioFile = file;
      document.getElementById('portfolio-file-name').textContent = file.name;
      const sizeKb = (file.size / 1024).toFixed(1);
      document.getElementById('portfolio-file-size').textContent = `${sizeKb} KB \u2022 ${ext.toUpperCase().slice(1)}`;
      document.getElementById('portfolio-file-info').style.display = 'block';

      // Parse the file
      const reader = new FileReader();
      reader.onload = async (e) => {
        const content = e.target.result;
        portfolioFileHash = await hashString(content);
        try {
          if (ext === '.json') {
            portfolioParsedOrders = parseJsonPortfolio(content);
          } else {
            portfolioParsedOrders = parseCsvPortfolio(content);
          }
          showPortfolioPreview(portfolioParsedOrders);
        } catch (err) {
          document.getElementById('portfolio-preview').innerHTML = `<p style="color:#f87171; font-size:12px;">Parse error: ${err.message}</p>`;
          document.getElementById('portfolio-preview').style.display = 'block';
        }
      };
      reader.readAsText(file);
    }

    async function hashString(str) {
      const encoder = new TextEncoder();
      const data = encoder.encode(str);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function parseCsvPortfolio(content) {
      const lines = content.trim().split('\n');
      if (lines.length < 2) throw new Error('CSV must have a header row and at least one data row');
      const delim = lines[0].includes('\t') ? '\t' : lines[0].includes(';') ? ';' : ',';
      const headers = lines[0].split(delim).map(h => h.trim().toLowerCase().replace(/['"]/g, ''));
      const colMap = {
        date: headers.findIndex(h => ['date','trade date','tradedate'].includes(h)),
        symbol: headers.findIndex(h => ['symbol','ticker','stock','isin'].includes(h)),
        type: headers.findIndex(h => ['type','action','side','transaction type'].includes(h)),
        quantity: headers.findIndex(h => ['quantity','shares','qty','amount'].includes(h)),
        unitPrice: headers.findIndex(h => ['price','unit price','unitprice','price per share'].includes(h)),
        fee: headers.findIndex(h => ['fee','commission','fees'].includes(h)),
        currency: headers.findIndex(h => ['currency','cur'].includes(h)),
      };
      if (colMap.date === -1 || colMap.symbol === -1) throw new Error('CSV must have Date and Symbol columns');
      const orders = [];
      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(delim).map(c => c.trim().replace(/['"]/g, ''));
        if (cols.length < 2 || !cols[colMap.date]) continue;
        const rawType = (colMap.type >= 0 ? cols[colMap.type] : 'BUY').toUpperCase();
        const type = rawType.includes('SELL') ? 'SELL' : rawType.includes('DIV') ? 'DIVIDEND' : 'BUY';
        orders.push({
          date: cols[colMap.date],
          symbol: cols[colMap.symbol],
          type,
          quantity: parseFloat(cols[colMap.quantity] || '0') || 0,
          unitPrice: parseFloat(cols[colMap.unitPrice] || '0') || 0,
          fee: colMap.fee >= 0 ? (parseFloat(cols[colMap.fee] || '0') || 0) : 0,
          currency: colMap.currency >= 0 ? (cols[colMap.currency] || 'USD') : 'USD',
        });
      }
      if (orders.length === 0) throw new Error('No valid orders found in CSV');
      return orders;
    }

    function parseJsonPortfolio(content) {
      const data = JSON.parse(content);
      // Support Ghostfolio export format: { activities: [{...}] }
      const activities = data.activities || data.orders || (Array.isArray(data) ? data : []);
      if (activities.length === 0) throw new Error('No activities found in JSON');
      return activities.map(a => ({
        date: a.date || a.Date || '',
        symbol: a.symbol || a.Symbol || a.ticker || '',
        type: (a.type || a.Type || 'BUY').toUpperCase(),
        quantity: parseFloat(a.quantity || a.Quantity || 0),
        unitPrice: parseFloat(a.unitPrice || a.price || a.Price || 0),
        fee: parseFloat(a.fee || a.Fee || 0),
        currency: a.currency || a.Currency || 'USD',
        dataSource: a.dataSource || a.DataSource || undefined,
      }));
    }

    function showPortfolioPreview(orders) {
      const preview = document.getElementById('portfolio-preview');
      let html = `<h3 style="color:#36cfb4; font-size:13px; margin-bottom:8px;">Preview (${orders.length} orders)</h3>`;
      html += '<div style="max-height:250px; overflow-y:auto;">';
      html += '<table style="width:100%; font-size:11px; border-collapse:collapse;">';
      html += '<tr style="color:#888; border-bottom:1px solid #333;"><th style="padding:4px;">Date</th><th style="padding:4px;">Symbol</th><th style="padding:4px;">Type</th><th style="padding:4px;">Qty</th><th style="padding:4px;">Price</th><th style="padding:4px;">Fee</th><th style="padding:4px;">Cur</th></tr>';
      for (const o of orders.slice(0, 50)) {
        const typeColor = o.type === 'BUY' ? '#4CAF50' : o.type === 'SELL' ? '#f87171' : '#FFC107';
        html += `<tr style="border-bottom:1px solid #1a1a1a;"><td style="padding:4px; color:#999;">${o.date}</td><td style="padding:4px; color:#ccc; font-weight:600;">${o.symbol}</td><td style="padding:4px; color:${typeColor};">${o.type}</td><td style="padding:4px; color:#e0e0e0;">${o.quantity}</td><td style="padding:4px; color:#e0e0e0;">${o.unitPrice}</td><td style="padding:4px; color:#888;">${o.fee}</td><td style="padding:4px; color:#888;">${o.currency}</td></tr>`;
      }
      if (orders.length > 50) html += `<tr><td colspan="7" style="padding:6px; color:#666; text-align:center;">...and ${orders.length - 50} more</td></tr>`;
      html += '</table></div>';
      html += '<div style="margin-top:12px; display:flex; gap:8px;">';
      html += '<button onclick="startPortfolioImport()" style="padding:8px 16px; background:#36cfb4; color:#000; border:none; border-radius:6px; font-weight:600; cursor:pointer; font-size:13px;">Import Portfolio</button>';
      html += '<button onclick="clearPortfolioFile()" style="padding:8px 16px; background:#1a1a1a; color:#e0e0e0; border:1px solid #333; border-radius:6px; cursor:pointer; font-size:13px;">Cancel</button>';
      html += '</div>';
      preview.innerHTML = html;
      preview.style.display = 'block';
    }

    async function startPortfolioImport() {
      if (!portfolioParsedOrders.length) return;

      // Check for duplicates
      try {
        const dupRes = await fetch(`${API_BASE}/admin/portfolio/check-duplicate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` },
          body: JSON.stringify({ fileHash: portfolioFileHash })
        });
        const dupData = await dupRes.json();
        if (dupData.duplicate) {
          alert(`This file was already imported on ${new Date(dupData.existing.createdAt).toLocaleString()}. Each file can only be imported once.`);
          return;
        }
      } catch (e) { /* proceed if check fails */ }

      // Confirmation dialog
      const confirmed = confirm(
        `\u26A0\uFE0F PORTFOLIO IMPORT\n\n` +
        `This will create ${portfolioParsedOrders.length} orders in your Ghostfolio portfolio.\n\n` +
        `Symbols: ${[...new Set(portfolioParsedOrders.map(o => o.symbol))].join(', ')}\n\n` +
        `This action can be rolled back once after completion.\n\n` +
        `Are you sure you want to proceed?`
      );
      if (!confirmed) return;

      // Need an account ID  fetch accounts
      const preview = document.getElementById('portfolio-preview');
      preview.innerHTML = '<div class="ghost-loader"><div class="ghost-icon"><svg viewBox="0 0 512 512"><path d="M255.633,0C145.341,0.198,55.994,89.667,55.994,200.006v278.66c0,14.849,17.953,22.285,28.453,11.786l38.216-39.328 l54.883,55.994c6.51,6.509,17.063,6.509,23.572,0L256,451.124l54.883,55.994c6.509,6.509,17.062,6.509,23.571,0l54.884-55.994 l38.216,39.327c10.499,10.499,28.453,3.063,28.453-11.786V201.719C456.006,91.512,365.84-0.197,255.633,0z M172.664,266.674 c-27.572,0-50.001-22.429-50.001-50.001s22.43-50.001,50.001-50.001s50.001,22.43,50.001,50.001S200.236,266.674,172.664,266.674z M339.336,266.674c-27.572,0-50.001-22.429-50.001-50.001s22.43-50.001,50.001-50.001s50.001,22.43,50.001,50.001 S366.908,266.674,339.336,266.674z"/></svg></div><div class="loader-text">Importing orders<span class="loader-dots"></span></div></div>';

      try {
        // Get first account
        const acctRes = await fetch(`${API_BASE.replace('/admin','')}/chat`, { method: 'HEAD' }).catch(() => null);
        let accountId = '';
        try {
          const accts = await (await fetch(`/api/v1/account`, { headers: { 'Authorization': `Bearer ${TOKEN}` } })).json();
          if (accts.accounts && accts.accounts.length > 0) accountId = accts.accounts[0].id;
          else if (Array.isArray(accts) && accts.length > 0) accountId = accts[0].id;
        } catch (e) { /* will try without */ }

        const importRes = await fetch(`${API_BASE}/admin/portfolio/import`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` },
          body: JSON.stringify({
            orders: portfolioParsedOrders,
            fileName: portfolioFile.name,
            fileHash: portfolioFileHash,
            accountId: accountId
          })
        });
        const result = await importRes.json();
        if (importRes.status === 409) {
          preview.innerHTML = `<p style="color:#FFC107; font-size:13px;">\u26A0\uFE0F ${result.detail || 'This file has already been imported.'}</p>`;
          return;
        }
        let html = '<div class="admin-section">';
        html += `<h3 style="color:#36cfb4; font-size:13px;">Import Complete</h3>`;
        html += `<p style="color:#ccc; font-size:12px;"><span style="color:#4CAF50; font-weight:600;">${result.created}</span> orders created`;
        if (result.failed > 0) html += `, <span style="color:#f87171; font-weight:600;">${result.failed}</span> failed`;
        html += `</p>`;
        if (result.errors && result.errors.length > 0) {
          html += '<div style="margin-top:8px;">';
          for (const e of result.errors.slice(0, 5)) {
            html += `<div style="color:#f87171; font-size:11px;">${e.symbol}: ${e.error}</div>`;
          }
          html += '</div>';
        }
        if (result.importId) {
          html += `<button onclick="rollbackImport('${result.importId}')" style="margin-top:12px; padding:8px 16px; background:#1a1a1a; color:#f87171; border:1px solid #f87171; border-radius:6px; cursor:pointer; font-size:12px;">Rollback Import</button>`;
        }
        html += '</div>';
        preview.innerHTML = html;
        loadImportHistory();
      } catch (err) {
        preview.innerHTML = `<p style="color:#f87171; font-size:12px;">Import failed: ${err.message}</p>`;
      }
    }

    async function rollbackImport(importId) {
      if (!confirm('Are you sure you want to rollback this import? All created orders will be deleted.')) return;
      try {
        const res = await fetch(`${API_BASE}/admin/portfolio/rollback/${importId}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${TOKEN}` }
        });
        const data = await res.json();
        alert(`Rollback complete: ${data.deleted} orders deleted.`);
        loadImportHistory();
      } catch (err) {
        alert(`Rollback failed: ${err.message}`);
      }
    }

    async function loadImportHistory() {
      const container = document.getElementById('portfolio-history');
      if (!container) return;
      try {
        const res = await fetch(`${API_BASE}/admin/portfolio/history`, {
          headers: { 'Authorization': `Bearer ${TOKEN}` }
        });
        const data = await res.json();
        const imports = data.imports || [];
        if (imports.length === 0) {
          container.innerHTML = '<div class="admin-placeholder">No imports yet.</div>';
          container.style.display = 'block';
          return;
        }
        let html = '<table style="width:100%; font-size:12px; border-collapse:collapse;">';
        html += '<tr style="color:#888; border-bottom:1px solid #333;"><th style="padding:6px;">Date</th><th style="padding:6px;">File</th><th style="padding:6px;">Orders</th><th style="padding:6px;">Status</th><th style="padding:6px;"></th></tr>';
        for (const imp of imports) {
          const date = new Date(imp.createdAt).toLocaleString('en-US', {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
          const statusColor = imp.status === 'completed' ? '#4CAF50' : imp.status === 'rolled_back' ? '#888' : imp.status === 'failed' ? '#f87171' : '#FFC107';
          const rollbackBtn = imp.status === 'completed' ? `<button onclick="rollbackImport('${imp.id}')" style="padding:2px 8px; background:none; color:#f87171; border:1px solid #f87171; border-radius:4px; cursor:pointer; font-size:10px;">Rollback</button>` : '';
          html += `<tr style="border-bottom:1px solid #1a1a1a;"><td style="padding:6px; color:#999;">${date}</td><td style="padding:6px; color:#ccc;">${imp.fileName}</td><td style="padding:6px; color:#e0e0e0;">${imp.ordersCreated}</td><td style="padding:6px; color:${statusColor}; font-weight:600;">${imp.status}</td><td style="padding:6px;">${rollbackBtn}</td></tr>`;
        }
        html += '</table>';
        container.innerHTML = html;
        container.style.display = 'block';
      } catch (err) {
        container.innerHTML = `<div style="color:#f87171; font-size:12px;">Error: ${err.message}</div>`;
        container.style.display = 'block';
      }
    }

    function clearPortfolioFile() {
      portfolioFile = null;
      portfolioParsedOrders = [];
      portfolioFileHash = '';
      document.getElementById('portfolio-file-info').style.display = 'none';
      document.getElementById('portfolio-file-input').value = '';
      const preview = document.getElementById('portfolio-preview');
      if (preview) { preview.style.display = 'none'; preview.innerHTML = ''; }
    }

    // ---- Analytics (Langfuse Traces) ----
    async function loadTraces() {
      const loading = document.getElementById('traces-loading');
      const content = document.getElementById('traces-content');
      const errorEl = document.getElementById('traces-error');
      loading.style.display = 'block';
      content.style.display = 'none';
      errorEl.style.display = 'none';

      try {
        const res = await fetch(`${API_BASE}/admin/traces`);
        const data = await res.json();
        if (data.error) {
          errorEl.style.display = 'block';
          errorEl.innerHTML = `<p style="color:#ff4444;">${data.error}</p>`;
          loading.style.display = 'none';
          return;
        }

        const ls = data.latencyStats;
        const sr = data.successRate;

        // KPI cards
        document.getElementById('t-avg-latency').textContent = `${ls.avg}s`;
        document.getElementById('t-p95-latency').textContent = `${ls.p95}s`;
        document.getElementById('t-success-rate').textContent = `${sr.rate}%`;
        document.getElementById('t-total-traces').textContent = sr.total;

        // Performance metrics
        document.getElementById('t-stat-avg').textContent = `${ls.avg}s`;
        document.getElementById('t-stat-p50').textContent = `${ls.p50}s`;
        document.getElementById('t-stat-p95').textContent = `${ls.p95}s`;
        document.getElementById('t-stat-ttft').textContent = `${ls.avgTtft}s`;
        document.getElementById('t-stat-success').textContent = sr.success;
        document.getElementById('t-stat-errors').textContent = sr.errors;

        // Latency distribution chart
        const ld = data.latencyDistribution;
        const maxLd = Math.max(...Object.values(ld), 1);
        const chartEl = document.getElementById('t-latency-chart');
        const labelsEl = document.getElementById('t-latency-labels');
        chartEl.innerHTML = '';
        labelsEl.innerHTML = '';
        for (const [bucket, count] of Object.entries(ld)) {
          const pct = (count / maxLd) * 100;
          chartEl.innerHTML += `<div style="flex:1; background:#36cfb4; border-radius:3px 3px 0 0; height:${Math.max(pct, 2)}%; display:flex; align-items:flex-start; justify-content:center; min-height:4px;" title="${bucket}: ${count}"><span style="font-size:9px; color:#fff; margin-top:2px;">${count || ''}</span></div>`;
          labelsEl.innerHTML += `<div style="flex:1; text-align:center; font-size:9px; color:#888;">${bucket}</div>`;
        }

        // Daily usage chart
        const daily = data.dailyChart;
        if (daily.length > 0) {
          const maxTraces = Math.max(...daily.map(d => d.traces), 1);
          const dailyChartEl = document.getElementById('t-daily-chart');
          const dailyLabelsEl = document.getElementById('t-daily-labels');
          dailyChartEl.innerHTML = '';
          dailyLabelsEl.innerHTML = '';
          for (const d of daily) {
            const pct = (d.traces / maxTraces) * 100;
            const dateShort = d.date.slice(5); // MM-DD
            dailyChartEl.innerHTML += `<div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:flex-end; height:100%;"><span style="font-size:9px; color:#ccc; margin-bottom:2px;">${d.traces}</span><div style="width:100%; background:#36cfb4; border-radius:3px 3px 0 0; height:${Math.max(pct, 4)}%; opacity:0.8;"></div></div>`;
            dailyLabelsEl.innerHTML += `<div style="flex:1; text-align:center; font-size:9px; color:#888;">${dateShort}</div>`;
          }
        } else {
          document.getElementById('t-daily-chart').innerHTML = '<div style="color:#666; padding:20px; text-align:center;">No daily data yet</div>';
        }

        // Recent traces table
        const tracesEl = document.getElementById('t-recent-traces');
        if (data.recentTraces.length > 0) {
          let html = '<table style="width:100%; font-size:11px; border-collapse:collapse;">';
          html += '<tr style="color:#888; text-align:left; border-bottom:1px solid #333;"><th style="padding:6px;">Time</th><th style="padding:6px;">Latency</th><th style="padding:6px;">Cost</th><th style="padding:6px;">Obs</th></tr>';
          for (const t of data.recentTraces) {
            const time = t.timestamp ? new Date(t.timestamp).toLocaleString('en-US', {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '--';
            const lat = t.latency ? `${t.latency.toFixed(1)}s` : '--';
            const cost = t.cost ? `$${t.cost.toFixed(6)}` : '--';
            const latColor = t.latency > 10 ? '#ff4444' : t.latency > 5 ? '#FFC107' : '#4CAF50';
            html += `<tr style="border-bottom:1px solid #1a1a1a;"><td style="padding:5px 6px; color:#999;">${time}</td><td style="padding:5px 6px; color:${latColor}; font-weight:600;">${lat}</td><td style="padding:5px 6px; color:#36cfb4;">${cost}</td><td style="padding:5px 6px; color:#888;">${t.observations}</td></tr>`;
          }
          html += '</table>';
          tracesEl.innerHTML = html;
        } else {
          tracesEl.innerHTML = '<div style="color:#666; padding:8px;">No traces yet</div>';
        }

        loading.style.display = 'none';
        content.style.display = 'block';

        // Staggered fade-in for each section
        content.querySelectorAll('.admin-section').forEach((sec, i) => {
          sec.classList.remove('fade-in-section');
          sec.style.animationDelay = `${i * 0.15}s`;
          // Force reflow then add class
          void sec.offsetWidth;
          sec.classList.add('fade-in-section');
        });
      } catch (e) {
        loading.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.innerHTML = `<p style="color:#ff4444;">Failed to load traces: ${e.message}</p>`;
      }
    }

    // ---- Cost Analysis ----
    async function loadCostAnalysis() {
      const loading = document.getElementById('costs-loading');
      const content = document.getElementById('costs-content');
      const errorEl = document.getElementById('costs-error');
      loading.style.display = 'block';
      content.style.display = 'none';
      errorEl.style.display = 'none';

      try {
        const res = await fetch(`${API_BASE}/admin/analytics`);
        const data = await res.json();

        if (data.error) {
          errorEl.style.display = 'block';
          errorEl.innerHTML = `<p style="color:#ff4444;">${data.error}</p>`;
          loading.style.display = 'none';
          return;
        }

        const dev = data.devCosts;
        const proj = data.projections;
        const assumptions = data.assumptions;

        document.getElementById('c-total-calls').textContent = dev.totalCalls.toLocaleString();
        document.getElementById('c-input-tokens').textContent = dev.totalInputTokens.toLocaleString();
        document.getElementById('c-output-tokens').textContent = dev.totalOutputTokens.toLocaleString();
        document.getElementById('c-total-tokens').textContent = dev.totalTokens.toLocaleString();
        document.getElementById('c-total-cost').textContent = `$${dev.totalCost.toFixed(4)}`;
        document.getElementById('c-obs-cost').textContent = dev.observabilityCost === 0 ? '$0.00 (free tier)' : `$${dev.observabilityCost.toFixed(2)}`;

        const modelEl = document.getElementById('c-model-breakdown');
        let modelHtml = '';
        for (const [model, info] of Object.entries(dev.byModel)) {
          modelHtml += `<div class="admin-list-item"><span class="label" style="flex:2;">${model}</span><span class="value" style="flex:1;">${info.calls} calls</span><span class="value" style="flex:1;">${(info.inputTokens + info.outputTokens).toLocaleString()} tok</span><span class="value" style="flex:1; color:#36cfb4;">$${info.cost.toFixed(4)}</span></div>`;
        }
        modelEl.innerHTML = modelHtml || '<div style="color:#666; padding:8px;">No data</div>';

        for (const count of ['100', '1000', '10000', '100000']) {
          const p = proj[count];
          document.getElementById(`c-proj-${count}`).textContent = `$${p.monthlyCost.toFixed(2)}/mo`;
        }

        const aEl = document.getElementById('c-assumptions');
        aEl.innerHTML = `
          <div class="admin-list-item"><span class="label">Queries per user per day</span><span class="value">${assumptions.queriesPerUserPerDay}</span></div>
          <div class="admin-list-item"><span class="label">Avg input tokens per query</span><span class="value">${assumptions.avgInputTokensPerQuery.toLocaleString()}</span></div>
          <div class="admin-list-item"><span class="label">Avg output tokens per query</span><span class="value">${assumptions.avgOutputTokensPerQuery.toLocaleString()}</span></div>
          <div class="admin-list-item"><span class="label">Avg cost per query</span><span class="value">$${assumptions.avgCostPerQuery.toFixed(6)}</span></div>
          <div class="admin-list-item"><span class="label">Avg tool calls per query</span><span class="value">${assumptions.avgToolCallsPerQuery}</span></div>
          <div class="admin-list-item"><span class="label">Model</span><span class="value">${assumptions.model}</span></div>
        `;

        loading.style.display = 'none';
        content.style.display = 'block';

        // Staggered fade-in for each section
        content.querySelectorAll('.admin-section').forEach((sec, i) => {
          sec.classList.remove('fade-in-section');
          sec.style.animationDelay = `${i * 0.15}s`;
          void sec.offsetWidth;
          sec.classList.add('fade-in-section');
        });
      } catch (e) {
        loading.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.innerHTML = `<p style="color:#ff4444;">Failed to load cost data: ${e.message}</p>`;
      }
    }

    // ---- Help Menu & Changelog ----
    function toggleHelpMenu() {
      document.getElementById('help-menu').classList.toggle('visible');
    }
    document.addEventListener('click', (e) => {
      const fab = document.getElementById('help-fab');
      const menu = document.getElementById('help-menu');
      if (menu && fab && !fab.contains(e.target) && !menu.contains(e.target)) {
        menu.classList.remove('visible');
      }
    });

    async function showChangelog() {
      document.getElementById('help-menu').classList.remove('visible');
      const body = document.getElementById('changelog-body');
      body.innerHTML = '<div style="text-align:center; padding:24px; color:#888;">Loading...</div>';
      document.getElementById('changelog-overlay').classList.add('visible');
      try {
        const res = await fetch('/static/changelog.json');
        const data = await res.json();
        const repos = data.repos || {};
        body.innerHTML = data.entries.map(e => {
          const repoUrl = repos[e.repo] || repos['agent-folio'] || '#';
          const link = e.commit
            ? `<a class="changelog-link" href="${repoUrl}/commit/${e.commit}" target="_blank" rel="noopener">Code changes</a>`
            : '';
          return `
          <div class="changelog-entry">
            <div class="changelog-entry-top">
              <div class="changelog-entry-left">
                <span class="changelog-date">${e.date}</span>
                <span class="changelog-title">${e.title}</span>
              </div>
              ${link}
            </div>
            <div class="changelog-desc">${e.desc}</div>
          </div>`;
        }).join('');
      } catch (err) {
        body.innerHTML = '<div style="color:#f87171; padding:24px;">Failed to load changelog.</div>';
      }
    }
    function closeChangelog() {
      document.getElementById('changelog-overlay').classList.remove('visible');
    }

    // ---- Disclaimer ----
    function showDisclaimer() {
      document.getElementById('help-menu').classList.remove('visible');
      document.getElementById('disclaimer-overlay').classList.add('visible');
    }
    function closeDisclaimer() {
      document.getElementById('disclaimer-overlay').classList.remove('visible');
    }

    // ---- Discover Features ----
    const UPCOMING_FEATURES = [
      { icon: '&#128200;', title: 'FIRE Calculator', desc: 'Financial Independence / Retire Early calculator with safe withdrawal rates, retirement projections, and monthly withdrawal calculations.' },
      { icon: '&#128176;', title: 'Dividend Tracking', desc: 'Dedicated dividend history analysis grouped by date and symbol, with income trend visualization.' },
      { icon: '&#128202;', title: 'Benchmark Comparison', desc: 'Compare your portfolio performance against market indices like the S&P 500, NASDAQ, and more.' },
      { icon: '&#128200;', title: 'Performance Over Time', desc: 'Detailed performance charts for Today, WTD, MTD, YTD, 1Y, 5Y, and Max periods with annualized returns.' },
      { icon: '&#127760;', title: 'Allocations by Dimension', desc: 'View portfolio allocation breakdowns by account, asset class, currency, region, and sector.' },
      { icon: '&#128269;', title: 'Watchlist', desc: 'Track symbols you don\'t own yet. Monitor potential investments and set price alerts.' },
      { icon: '&#128197;', title: 'Investment History', desc: 'Investment timeline with savings rate streaks and monthly/yearly investment patterns.' },
      { icon: '&#128300;', title: 'X-Ray Deep Analysis', desc: 'Comprehensive rules-based analysis engine checking diversification risk, fee ratios, liquidity, and currency concentration.' },
      { icon: '&#127974;', title: 'Account Balance History', desc: 'Historical balance tracking per account with trend analysis over time.' },
      { icon: '&#128279;', title: 'Public Portfolio Sharing', desc: 'Share read-only portfolio views with others for collaboration or transparency.' },
    ];

    function showFeatures() {
      document.getElementById('help-menu').classList.remove('visible');
      const body = document.getElementById('features-body');
      body.innerHTML = '<p style="color:#888; font-size:12px; margin-bottom:16px;">These powerful Ghostfolio features are being integrated into the AI assistant. Stay tuned!</p>';
      body.innerHTML += UPCOMING_FEATURES.map(f => `
        <div class="feature-item">
          <span class="feature-icon">${f.icon}</span>
          <div class="feature-info">
            <div class="feature-title">${f.title}</div>
            <div class="feature-desc">${f.desc}</div>
          </div>
          <span class="coming-soon-badge">Coming Soon</span>
        </div>
      `).join('');
      document.getElementById('features-overlay').classList.add('visible');
    }
    function closeFeatures() {
      document.getElementById('features-overlay').classList.remove('visible');
    }

    // ---- Logout ----
    function doLogout() {
      sessionStorage.removeItem('auth-token');
      sessionStorage.removeItem('is-grader');
      localStorage.removeItem('auth-token');
      TOKEN = '';
      IS_GRADER = false;
      currentConversationId = null;
      messages = [];
      allConversations = [];
      convListEl.innerHTML = '';
      const badge = document.getElementById('account-badge');
      if (badge) badge.style.display = 'none';
      const dd = document.getElementById('profile-dropdown');
      if (dd) dd.classList.remove('visible');
      _profileUserId = '';
      _profileShortId = '';
      _profileUsername = null;
      newConversation();
      showLoginOverlay();
    }

    // ---- First-Login Disclaimer ----
    function onDisclaimerCheckbox(checked) {
      const btn = document.getElementById('disclaimer-agree-btn');
      if (checked) {
        btn.classList.add('enabled');
        btn.disabled = false;
      } else {
        btn.classList.remove('enabled');
        btn.disabled = true;
      }
    }

    function acceptDisclaimer() {
      if (!document.getElementById('disclaimer-agree-checkbox').checked) return;
      localStorage.setItem('disclaimer-accepted', 'true');
      document.getElementById('first-login-overlay').classList.remove('visible');
    }

    function checkFirstLoginDisclaimer() {
      if (!localStorage.getItem('disclaimer-accepted')) {
        document.getElementById('first-login-overlay').classList.add('visible');
      }
    }

    // Show first-login disclaimer after authentication
    const _origOnAuth = onAuthenticated;
    onAuthenticated = function() {
      _origOnAuth();
      checkFirstLoginDisclaimer();
    };
    // Also check on initial load if already authenticated
    if (TOKEN) checkFirstLoginDisclaimer();
  </script>

  <!-- Add Backend Modal -->
  <div class="add-backend-modal" id="add-backend-modal">
    <div class="abm-content">
      <h3>Add Backend Connection</h3>
      <div class="abm-field">
        <label>Provider</label>
        <select id="abm-provider" onchange="onProviderChange()">
          <option value="ghostfolio">Ghostfolio</option>
          <option value="rotki">Rotki</option>
        </select>
      </div>
      <div class="abm-field">
        <label>Label (optional)</label>
        <input id="abm-label" type="text" placeholder="e.g. My Stocks" />
      </div>
      <div class="abm-field">
        <label>Base URL</label>
        <input id="abm-url" type="text" placeholder="http://localhost:3333" />
      </div>
      <div class="abm-field" id="abm-cred-token-field">
        <label>Security Token</label>
        <input id="abm-security-token" type="password" placeholder="Ghostfolio security token" />
      </div>
      <div class="abm-field" id="abm-cred-user-field" style="display:none;">
        <label>Username</label>
        <input id="abm-username" type="text" placeholder="Rotki username" />
      </div>
      <div class="abm-field" id="abm-cred-pass-field" style="display:none;">
        <label>Password</label>
        <input id="abm-password" type="password" placeholder="Rotki password" />
      </div>
      <div class="abm-actions">
        <button class="abm-cancel" onclick="hideAddBackendModal()">Cancel</button>
        <button class="abm-save" onclick="saveBackend()">Add</button>
      </div>
    </div>
  </div>
</body>
</html>

